{% extends 'c-word.html' %}

{% block title %} server - computer {% endblock title %}

{% block point1 %}
<article contenteditable="true">
  <p>Category: computer | server</p>
  <h1 id="blogTitle0">Server</h1><h2 id="blogTitle1">概述</h2><h3 id="blogTitle2">定义</h3><div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 28px; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">服务器，是提供计算服务的设备。由于服务器需要响应服务请求，并进行处理，因此一般来说服务器应具备承担服务并且保障服务的能力。</div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 28px; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">服务器的构成包括<a target="_blank" href="https://baike.baidu.com/item/%E5%A4%84%E7%90%86%E5%99%A8/914419" data-lemmaid="914419" style="color: rgb(19, 110, 194); text-decoration-line: none;">处理器</a>、<a target="_blank" href="https://baike.baidu.com/item/%E7%A1%AC%E7%9B%98/159825" data-lemmaid="159825" style="color: rgb(19, 110, 194); text-decoration-line: none;">硬盘</a>、<a target="_blank" href="https://baike.baidu.com/item/%E5%86%85%E5%AD%98/103614" data-lemmaid="103614" style="color: rgb(19, 110, 194); text-decoration-line: none;">内存</a>、<a target="_blank" href="https://baike.baidu.com/item/%E7%B3%BB%E7%BB%9F" style="color: rgb(19, 110, 194); text-decoration-line: none;">系统</a><a target="_blank" href="https://baike.baidu.com/item/%E6%80%BB%E7%BA%BF" style="color: rgb(19, 110, 194); text-decoration-line: none;">总线</a>等，和通用的计算机架构类似，但是由于需要<a target="_blank" href="https://baike.baidu.com/item/%E6%8F%90%E4%BE%9B/2290673" data-lemmaid="2290673" style="color: rgb(19, 110, 194); text-decoration-line: none;">提供</a>高可靠的服务，因此在处理能力、稳定性、可靠性、安全性、可扩展性、可管理性等方面要求较高。</div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 28px; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">在网络环境下，根据服务器提供的服务类型不同，分为文件服务器、<a target="_blank" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8/613818" data-lemmaid="613818" style="color: rgb(19, 110, 194); text-decoration-line: none;">数据库服务器</a>、应用程序服务器、WEB服务器等。</div></div><h3 id="blogTitle3">组成</h3><div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 28px; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">服务器的构成包括<a target="_blank" href="https://baike.baidu.com/item/%E5%A4%84%E7%90%86%E5%99%A8/914419" data-lemmaid="914419" style="color: rgb(19, 110, 194); text-decoration-line: none;">处理器</a>、<a target="_blank" href="https://baike.baidu.com/item/%E7%A1%AC%E7%9B%98/159825" data-lemmaid="159825" style="color: rgb(19, 110, 194); text-decoration-line: none;">硬盘</a>、<a target="_blank" href="https://baike.baidu.com/item/%E5%86%85%E5%AD%98/103614" data-lemmaid="103614" style="color: rgb(19, 110, 194); text-decoration-line: none;">内存</a>、<a target="_blank" href="https://baike.baidu.com/item/%E7%B3%BB%E7%BB%9F" style="color: rgb(19, 110, 194); text-decoration-line: none;">系统</a><a target="_blank" href="https://baike.baidu.com/item/%E6%80%BB%E7%BA%BF" style="color: rgb(19, 110, 194); text-decoration-line: none;">总线</a>等，和通用的计算机架构类似，但是由于需要<a target="_blank" href="https://baike.baidu.com/item/%E6%8F%90%E4%BE%9B/2290673" data-lemmaid="2290673" style="color: rgb(19, 110, 194); text-decoration-line: none;">提供</a>高可靠的服务，因此在处理能力、稳定性、可靠性、安全性、可扩展性、可管理性等方面要求较高。</div></div><h3 id="blogTitle4">特性<br></h3><div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">可以从这几个方面来衡量服务器是否达到了其设计目的；R：Reliability可靠性；A：Availability可用性；S：Scalability可扩展性；U：Usability易用性；M：Manageability可管理性，即服务器的RASUM衡量<a target="_blank" href="https://baike.baidu.com/item/%E6%A0%87%E5%87%86" style="color: rgb(19, 110, 194); text-decoration-line: none;">标准</a>。</div></div><div><h4 style="overflow-wrap: break-word; margin-bottom: 15px; line-height: 24px; zoom: 1;" id="blogTitle5">可扩展性</h4><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">服务器必须具有一定的“可扩展性”，这是因为企业网络不可能长久不变，特别是在当今信息时代。如果服务器没有一定的可扩展性，当用户一增多就不能胜任的话，一台价值几万，甚至几十万的服务器在短时间内就要遭到淘汰，这是任何企业都无法承受的。为了保持可扩展性，通常需要在服务器上具备一定的可扩展空间和冗余件（如<a target="_blank" href="https://baike.baidu.com/item/%E7%A3%81%E7%9B%98%E9%98%B5%E5%88%97" style="color: rgb(19, 110, 194); text-decoration-line: none;">磁盘阵列</a>架位、PCI和内存条插槽位等）。</div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">可扩展性具体体现在硬盘是否可扩充，CPU 是否可升级或扩展，系统是否支持 WindowsNT、<a target="_blank" href="https://baike.baidu.com/item/Linux" style="color: rgb(19, 110, 194); text-decoration-line: none;">Linux</a>&nbsp;或&nbsp;<a target="_blank" href="https://baike.baidu.com/item/UNIX" style="color: rgb(19, 110, 194); text-decoration-line: none;">UNIX</a>&nbsp;等多种可选主流操作系统等方面，只有这样才能保持前期投资为后期充分利用。</div><h4 style="overflow-wrap: break-word; margin-bottom: 15px; line-height: 24px; zoom: 1;" id="blogTitle6">易使用性</h4><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">服务器的功能相对于 PC 机来说复杂许多，不仅指其硬件配置，更多的是指其软件系统配置。服务器要实现如此多的功能，没有全面的软件支持是无法想象的。但是<a target="_blank" href="https://baike.baidu.com/item/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F" style="color: rgb(19, 110, 194); text-decoration-line: none;">软件系统</a>一多，又可能造成服务器的使用性能下降，管理人员无法有效操纵。所以许多服务器厂商在进行服务器的设计时，除了在服务器的可用性、稳定性等方面要充分考虑外，还必须在服务器的易使用性方面下足功夫。</div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">服务器的易使用性主要体现在服务器是不是容易操作，用户<a target="_blank" href="https://baike.baidu.com/item/%E5%AF%BC%E8%88%AA%E7%B3%BB%E7%BB%9F" style="color: rgb(19, 110, 194); text-decoration-line: none;">导航系统</a>是不是完善，机箱设计是不是人性化，有没有关键恢复功能，是否有操作系统备份，以及有没有足够的培训支持等方面。</div><h4 style="overflow-wrap: break-word; margin-bottom: 15px; line-height: 24px; zoom: 1;" id="blogTitle7">可用性</h4><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">对于一台服务器而言，一个非常重要的方面就是它的“可用性”，即所选服务器能满足长期稳定工作的要求，不能经常出问题。其实就等同于 Sun 所提出的可靠性（Reliability）。</div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">因为服务器所面对的是整个网络的用户，而不是单个用户，在大中型企业中，通常要求服务器是永不中断的。在一些特殊应用领域，即使没有<a target="_blank" href="https://baike.baidu.com/item/%E7%94%A8%E6%88%B7" style="color: rgb(19, 110, 194); text-decoration-line: none;">用户</a>使用，有些服务器也得不间断地工作，因为它必须持续地为用户提供连接服务，而不管是在上班，还是下班，也不管是工作日，还是休息、节假日。这就是要求服务器必须具备极高的稳定性的根本原因。</div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">一般来说专门的服务器都要 7X24 小时不间断地工作，特别像一些大型的网络服务器，如大公司所用服务器、网站服务器，以及提供公众服务 iqdeWEB 服务器等更是如此。对于这些服务器来说，也许真正工作开机的次数只有一次，那就是它刚买回全面安装配置好后投入正式使用的那一次，此后，它不间断地工作，一直到彻底报废。如果动不动就出毛病，则网络不可能保持长久正常运作。为了确保服务器具有高得“可用性”，除了要求各配件质量过关外，还可采取必要的技术和配置措施，如<a target="_blank" href="https://baike.baidu.com/item/%E7%A1%AC%E4%BB%B6%E5%86%97%E4%BD%99" style="color: rgb(19, 110, 194); text-decoration-line: none;">硬件冗余</a>、在线诊断等。</div><h4 style="overflow-wrap: break-word; margin-bottom: 15px; line-height: 24px; zoom: 1;" id="blogTitle8">易管理性</h4><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">在服务器的主要特性中，还有一个重要特性，那就是服务器的“易管理性”。虽然我们说服务器需要不间断地持续工作，但再好的产品都有可能出现故障，拿人们常说的一句话来说就是：不是不知道它可能坏，而是不知道它何时坏。服务器虽然在稳定性方面有足够保障，但也应有必要的避免出错的措施，以及时发现问题，而且出了故障也能及时得到维护。这不仅可减少服务器出错的机会，同时还可大大提高服务器维护的效率。其实也就是 Sun 提出的可服务性（Serviceability）。</div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 2em; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">服务器的易管理性还体现在服务器有没有智能管理系统，有没有自动报警功能，是不是有独立与系统的管理系统，有没有液晶监视器等方面。只有这样，管理员才能轻松管理，高效工作。</div></div><div><br></div><div><br></div><h3 id="blogTitle9">分类</h3><div><div class="para" label-module="para" style="font-size: 14px; overflow-wrap: break-word; color: rgb(51, 51, 51); margin-bottom: 15px; text-indent: 28px; line-height: 24px; zoom: 1; font-family: arial, 宋体, sans-serif; background-color: rgb(255, 255, 255);">在网络环境下，根据服务器提供的服务类型不同，分为文件服务器、<a target="_blank" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8/613818" data-lemmaid="613818" style="color: rgb(19, 110, 194); text-decoration-line: none;">数据库服务器</a>、应用程序服务器、WEB 服务器等。</div></div><h4 id="blogTitle10">按服务类型分</h4><h5 id="blogTitle11">文件服务器</h5><h5 id="blogTitle12">数据库服务器</h5><h5 id="blogTitle13">应用程序服务器</h5><h5 id="blogTitle14">Web 服务器</h5><h4 id="blogTitle15">按体系架构分</h4><h5 id="blogTitle16">非 x86 服务器</h5><h5 id="blogTitle17">x86 服务器</h5><h4 id="blogTitle18">按应用层次分</h4><div><span style="color: rgb(51, 51, 51); font-family: arial, 宋体, sans-serif; font-size: 14px; text-indent: 28px; background-color: rgb(255, 255, 255);">按应用层次划分通常也称为“按服务器</span><a target="_blank" href="https://baike.baidu.com/item/%E6%A1%A3%E6%AC%A1" style="color: rgb(19, 110, 194); text-decoration-line: none; font-family: arial, 宋体, sans-serif; font-size: 14px; text-indent: 28px; background-color: rgb(255, 255, 255);">档次</a><span style="color: rgb(51, 51, 51); font-family: arial, 宋体, sans-serif; font-size: 14px; text-indent: 28px; background-color: rgb(255, 255, 255);">划分”或 “按网络规模”分，是服务器最为普遍的一种划分方法，它主要根据服务器在网络中应用的层次（或服务器的档次来）来划分的。要注意的是这里所指的服务器档次并不是按</span><a target="_blank" href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8CPU" style="color: rgb(19, 110, 194); text-decoration-line: none; font-family: arial, 宋体, sans-serif; font-size: 14px; text-indent: 28px; background-color: rgb(255, 255, 255);">服务器CPU</a><span style="color: rgb(51, 51, 51); font-family: arial, 宋体, sans-serif; font-size: 14px; text-indent: 28px; background-color: rgb(255, 255, 255);">主频高低来划分，而是依据整个服务器的综合性能，特别是所采用的一些服务器专用技术来衡量的</span><br></div><h5 id="blogTitle19">入门级服务器</h5><h5 id="blogTitle20">工作组级服务器</h5><h5 id="blogTitle21">部门级服务器</h5><h5 id="blogTitle22">企业级服务器</h5><div><br></div><h3 id="blogTitle23">用途</h3><h4 id="blogTitle24">办公OA服务器</h4><h4 id="blogTitle25">ERP服务器</h4><h4 id="blogTitle26">WEB服务器</h4><h4 id="blogTitle27">数据库服务器</h4><h4 id="blogTitle28">财务服务器</h4><h4 id="blogTitle29">邮件服务器</h4><h4 id="blogTitle30">打印服务器</h4><h4 id="blogTitle31">集群服务器</h4><h4 id="blogTitle32">无盘办公系统</h4><h4 id="blogTitle33">无盘网吧服务器</h4><h4 id="blogTitle34">无盘教学系统</h4><h4 id="blogTitle35">视频监控服务器</h4><h4 id="blogTitle36">流媒体服务器</h4><h4 id="blogTitle37">VOD视频点播服务器</h4><h4 id="blogTitle38">网络下载</h4><h4 id="blogTitle39">SP服务</h4><h4 id="blogTitle40">网络教学服务器</h4><h4 id="blogTitle41">IDC-主机出租</h4><h4 id="blogTitle42">IDC-虚拟空间</h4><h4 id="blogTitle43">IDC-网游</h4><h4 id="blogTitle44">IDC-主机托管</h4><h4 id="blogTitle45">游戏服务器</h4><h4 id="blogTitle46">高性能计算(HPC)</h4><h4 id="blogTitle47">桌面超算</h4><h4 id="blogTitle48">论坛服务器</h4><h2 id="blogTitle49">服务器编程</h2><div><br></div><h3 id="blogTitle50">单进程服务器</h3><h4 id="blogTitle51">一个简单的 TCP 服务器</h4><div><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 16px; white-space: pre-wrap; break-inside: avoid; direction: ltr; border: none; color: rgb(51, 51, 51); overflow-wrap: normal; margin-top: 0px; margin-bottom: 1.275em; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); letter-spacing: 0.2px;"><code class="lang-python" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> socket <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> *

serSocket = socket(AF_INET, SOCK_STREAM)

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 重复使用绑定的信息</span>
serSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR  , <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1</span>)

localAddr = (<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">''</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">7788</span>)

serSocket.bind(localAddr)

serSocket.listen(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">5</span>)

<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:

    print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'-----主进程，，等待新客户端的到来------'</span>)

    newSocket,destAddr = serSocket.accept()

    print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'-----主进程，，接下来负责数据处理[%s]-----'</span>%str(destAddr))

    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">try</span>:
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:
            recvData = newSocket.recv(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1024</span>)
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> len(recvData)&gt;<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">0</span>:
                print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'recv[%s]:%s'</span>%(str(destAddr), recvData))
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
                print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'[%s]客户端已经关闭'</span>%str(destAddr))
                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">break</span>
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">finally</span>:
        newSocket.close()

serSocket.close()</code></pre></div><h4 id="blogTitle52">总结</h4><div><ul style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; margin-top: 0px; padding: 0px 0px 0px 2em; margin-right: 0px; margin-left: 0px; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px; margin-bottom: 0px !important;"><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">同一时刻只能为一个客户进行服务，不能同时为多个客户服务</li><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">类似于找一个“明星”签字一样，客户需要耐心等待才可以获取到服务</li><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;"><code style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0.2em; margin: 0px; background-color: rgb(247, 247, 247);">当服务器为一个客户端服务时，而另外的客户端发起了connect，只要服务器listen的队列有空闲的位置，就会为这个新客户端进行连接，并且客户端可以发送数据，但当服务器为这个新客户端服务时，可能一次性把所有数据接收完毕</code></li><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">当recv接收数据时，返回值为空，即没有返回数据，那么意味着客户端已经调用了close关闭了；因此服务器通过判断recv接收数据是否为空 来判断客户端是否已经下线</li></ul></div><div><br></div><h3 id="blogTitle53">多进程服务器</h3><h4>简单实现</h4><div><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 16px; white-space: pre-wrap; break-inside: avoid; direction: ltr; border: none; color: rgb(51, 51, 51); overflow-wrap: normal; margin-top: 0px; margin-bottom: 1.275em; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); letter-spacing: 0.2px;"><code class="lang-python" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> socket <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> *
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> multiprocessing <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> *
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> time <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> sleep

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 处理客户端的请求并为其服务</span>
<span class="hljs-function" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(66, 113, 174);"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">def</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">dealWithClient</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">(newSocket,destAddr)</span>:</span>
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:
        recvData = newSocket.recv(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1024</span>)
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> len(recvData)&gt;<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">0</span>:
            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'recv[%s]:%s'</span>%(str(destAddr), recvData))
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'[%s]客户端已经关闭'</span>%str(destAddr))
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">break</span>

    newSocket.close()


<span class="hljs-function" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(66, 113, 174);"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">def</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">main</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">()</span>:</span>

    serSocket = socket(AF_INET, SOCK_STREAM)
    serSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR  , <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1</span>)
    localAddr = (<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">''</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">7788</span>)
    serSocket.bind(localAddr)
    serSocket.listen(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">5</span>)

    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">try</span>:
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:
            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'-----主进程，，等待新客户端的到来------'</span>)
            newSocket,destAddr = serSocket.accept()

            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'-----主进程，，接下来创建一个新的进程负责数据处理[%s]-----'</span>%str(destAddr))
            client = Process(target=dealWithClient, args=(newSocket,destAddr))
            client.start()

            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#因为已经向子进程中copy了一份（引用），并且父进程中这个套接字也没有用处了</span>
            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#所以关闭</span>
            newSocket.close()
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">finally</span>:
        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#当为所有的客户端服务完之后再进行关闭，表示不再接收新的客户端的链接</span>
        serSocket.close()

<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> __name__ == <span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'__main__'</span>:
    main()</code></pre></div><h4>总结</h4><div><ul style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; margin-top: 0px; padding: 0px 0px 0px 2em; margin-right: 0px; margin-left: 0px; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px; margin-bottom: 0px !important;"><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">通过为每个客户端创建一个进程的方式，能够同时为多个客户端进行服务</li><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">当客户端不是特别多的时候，这种方式还行，如果有几百上千个，就不可取了，因为每次创建进程等过程需要好较大的资源</li></ul></div><h3 id="blogTitle54">多线程服务器</h3><h4>实现</h4><div><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 16px; white-space: pre-wrap; break-inside: avoid; direction: ltr; border: none; color: rgb(51, 51, 51); overflow-wrap: normal; margin-top: 0px; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); letter-spacing: 0.2px; margin-bottom: 0px !important;"><code class="lang-python" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#coding=utf-8</span>
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> socket <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> *
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> threading <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> Thread
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> time <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> sleep

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 处理客户端的请求并执行事情</span>
<span class="hljs-function" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(66, 113, 174);"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">def</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">dealWithClient</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">(newSocket,destAddr)</span>:</span>
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:
        recvData = newSocket.recv(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1024</span>)
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> len(recvData)&gt;<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">0</span>:
            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'recv[%s]:%s'</span>%(str(destAddr), recvData))
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'[%s]客户端已经关闭'</span>%str(destAddr))
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">break</span>

    newSocket.close()


<span class="hljs-function" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(66, 113, 174);"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">def</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">main</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">()</span>:</span>

    serSocket = socket(AF_INET, SOCK_STREAM)
    serSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR  , <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1</span>)
    localAddr = (<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">''</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">7788</span>)
    serSocket.bind(localAddr)
    serSocket.listen(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">5</span>)

    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">try</span>:
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:
            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'-----主进程，，等待新客户端的到来------'</span>)
            newSocket,destAddr = serSocket.accept()

            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'-----主进程，，接下来创建一个新的进程负责数据处理[%s]-----'</span>%str(destAddr))
            client = Thread(target=dealWithClient, args=(newSocket,destAddr))
            client.start()

            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#因为线程中共享这个套接字，如果关闭了会导致这个套接字不可用，</span>
            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#但是此时在线程中这个套接字可能还在收数据，因此不能关闭</span>
            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#newSocket.close() </span>
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">finally</span>:
        serSocket.close()

<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> __name__ == <span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'__main__'</span>:
    main()</code></pre></div><div><br></div><div><br></div><h3 id="blogTitle55">单进程服务器 - 非阻塞模式</h3><div><h4 style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; break-after: avoid; margin-top: 1.275em; margin-bottom: 0.85em;">服务器</h4><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 16px; white-space: pre-wrap; break-inside: avoid; direction: ltr; border: none; color: rgb(51, 51, 51); overflow-wrap: normal; margin-top: 0px; margin-bottom: 1.275em; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); letter-spacing: 0.2px;"><code class="lang-python" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#coding=utf-8</span>
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> socket <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> *
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> time

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 用来存储所有的新链接的socket</span>
g_socketList = []

<span class="hljs-function" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(66, 113, 174);"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">def</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">main</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">()</span>:</span>
    serSocket = socket(AF_INET, SOCK_STREAM)
    serSocket.setsockopt(SOL_SOCKET, SO_REUSEADDR  , <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1</span>)
    localAddr = (<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">''</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">7788</span>)
    serSocket.bind(localAddr)
    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#可以适当修改listen中的值来看看不同的现象</span>
    serSocket.listen(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1000</span>)
    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#将套接字设置为非堵塞</span>
    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#设置为非堵塞后，如果accept时，恰巧没有客户端connect，那么accept会</span>
    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#产生一个异常，所以需要try来进行处理</span>
    serSocket.setblocking(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">False</span>)

    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#用来测试</span>
        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#time.sleep(0.5)</span>

        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">try</span>:
            newClientInfo = serSocket.accept()
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">except</span>:
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">pass</span>
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"一个新的客户端到来:%s"</span>%str(newClientInfo))
            newClientInfo[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">0</span>].setblocking(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">False</span>)
            g_socketList.append(newClientInfo)

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 用来存储需要删除的客户端信息</span>
        needDelClientInfoList = []

        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">for</span> clientSocket,clientAddr <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> g_socketList:
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">try</span>:
                recvData = clientSocket.recv(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1024</span>)
                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> len(recvData)&gt;<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">0</span>:
                    print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'recv[%s]:%s'</span>%(str(clientAddr), recvData))
                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
                    print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'[%s]客户端已经关闭'</span>%str(clientAddr))
                    clientSocket.close()
                    needDelClientInfoList.append((clientSocket,clientAddr))
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">except</span> Exception <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">as</span> result:
                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">pass</span>

        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">for</span> needDelClientInfo <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> needDelClientInfoList:
            g_socketList.remove(needDelClientInfo)

<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> __name__ == <span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'__main__'</span>:
    main()</code></pre><h4 style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; break-after: avoid; margin-top: 1.275em; margin-bottom: 0.85em;">客户端</h4><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 16px; white-space: pre-wrap; break-inside: avoid; direction: ltr; border: none; color: rgb(51, 51, 51); overflow-wrap: normal; margin-top: 0px; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); letter-spacing: 0.2px; margin-bottom: 0px !important;"><code class="lang-python" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;">
<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#coding=utf-8</span>
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> socket <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> *
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> random
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> time

serverIp = raw_input(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"请输入服务器的ip:"</span>)
connNum = raw_input(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"请输入要链接服务器的次数(例如1000):"</span>)
g_socketList = []
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">for</span> i <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> range(int(connNum)):
    s = socket(AF_INET, SOCK_STREAM)
    s.connect((serverIp, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">7788</span>))
    g_socketList.append(s)
    print(i)

<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">for</span> s <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> g_socketList:
        s.send(str(random.randint(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">0</span>,<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">100</span>)))

    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 用来测试用</span>
    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#time.sleep(1)</span></code></pre></div><div><br></div><h3 id="blogTitle56">单进程服务器 - select 版</h3><h4>select 原理</h4><div><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">在多路复用的模型中，比较常用的有 select 模型和 epoll 模型。这两个都是系统接口，由操作系统提供。当然，Python 的 select 模块进行了更高级的封装。</p><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;"><ul><li>poll 和 select 几乎一样，机制都是轮询 - 效率慢，但 poll 可接收的套接字没有上限。</li><li>epoll 使用的是事件通知机制（效率比 select 和 poll 高），没有上限。</li></ul></p><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">网络通信被 Unix 系统抽象为文件的读写，通常是一个设备，由设备驱动程序提供，驱动可以知道自身的数据是否可用。支持阻塞操作的设备驱动通常会实现一组自身的等待队列，如读/写等待队列用于支持上层(用户层)所需的 block 或 non-block 操作。设备的文件的资源如果可用（可读或者可写）则会通知进程，反之则会让进程睡眠，等到数据到来可用的时候，再唤醒进程。</p><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">这些设备的文件描述符被放在一个数组中，然后 select 调用的时候遍历这个数组，如果对于的文件描述符可读则会返回该文件描述符。当遍历结束之后，如果仍然没有一个可用设备文件描述符，select 让用户进程则会睡眠，直到等待资源可用的时候在唤醒，遍历之前那个监视的数组。每次遍历都是依次进行判断的。</p></div><h4>select 回显服务器</h4><div><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">使用python的select模块很容易写出下面一个 echo(回显)服务器：</p><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 16px; white-space: pre-wrap; break-inside: avoid; direction: ltr; border: none; color: rgb(51, 51, 51); overflow-wrap: normal; margin-top: 0px; margin-bottom: 1.275em; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); letter-spacing: 0.2px;"><code class="lang-python" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> select
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> socket
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> sys


server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind((<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">''</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">7788</span>))
server.listen(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">5</span>)

inputs = [server, sys.stdin]

running = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>

<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:

    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 调用 select 函数，阻塞等待</span>
    readable, writeable, exceptional = select.select(inputs, [], [])

    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 数据抵达，循环</span>
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">for</span> sock <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> readable:

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 监听到有新的连接</span>
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> sock == server:
            conn, addr = server.accept()
            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># select 监听的socket</span>
            inputs.append(conn)

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 监听到键盘有输入</span>
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">elif</span> sock == sys.stdin:
            cmd = sys.stdin.readline()
            running = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">False</span>
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">break</span>

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 有数据到达</span>
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 读取客户端连接发送的数据</span>
            data = sock.recv(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1024</span>)
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> data:
                sock.send(data)
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 移除select监听的socket</span>
                inputs.remove(sock)
                sock.close()

    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 如果检测到用户输入敲击键盘，那么就退出</span>
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">not</span> running:
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">break</span>

server.close()</code></pre></div><h4>另外一个服务器（包含 writeList）</h4><div><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 16px; white-space: pre-wrap; break-inside: avoid; direction: ltr; border: none; color: rgb(51, 51, 51); overflow-wrap: normal; margin-top: 0px; margin-bottom: 1.275em; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); letter-spacing: 0.2px;"><code class="lang-python" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);">#coding=utf-8</span>
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> socket
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> Queue
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">from</span> select <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> select

SERVER_IP = (<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">''</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">9999</span>)

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 保存客户端发送过来的消息,将消息放入队列中  </span>
message_queue = {}
input_list = []
output_list = []

<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> __name__ == <span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"__main__"</span>:
    server = socket.socket()
    server.bind(SERVER_IP)
    server.listen(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">10</span>)
    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 设置为非阻塞  </span>
    server.setblocking(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">False</span>)

    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 初始化将服务端加入监听列表  </span>
    input_list.append(server)

    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:
        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 开始 select 监听,对input_list中的服务端server进行监听  </span>
        stdinput, stdoutput, stderr = select(input_list, output_list, input_list)

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 循环判断是否有客户端连接进来,当有客户端连接进来时select将触发  </span>
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">for</span> obj <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> stdinput:
            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 判断当前触发的是不是服务端对象, 当触发的对象是服务端对象时,说明有新客户端连接进来了  </span>
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> obj == server:
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 接收客户端的连接, 获取客户端对象和客户端地址信息  </span>
                conn, addr = server.accept()
                print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"Client %s connected! "</span>%str(addr))
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 将客户端对象也加入到监听的列表中, 当客户端发送消息时 select 将触发  </span>
                input_list.append(conn)
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 为连接的客户端单独创建一个消息队列，用来保存客户端发送的消息  </span>
                message_queue[conn] = Queue.Queue()

            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 由于客户端连接进来时服务端接收客户端连接请求，将客户端加入到了监听列表中(input_list)，客户端发送消息将触发  </span>
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 所以判断是否是客户端对象触发  </span>
                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">try</span>:
                    recv_data = obj.recv(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1024</span>)
                    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 客户端未断开  </span>
                    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> recv_data:
                        print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"received %s from client %s"</span>%(recv_data, str(addr)))
                        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 将收到的消息放入到各客户端的消息队列中  </span>
                        message_queue[obj].put(recv_data)

                        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 将回复操作放到output列表中，让select监听  </span>
                        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> obj <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">not</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> output_list:
                            output_list.append(obj)

                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">except</span> ConnectionResetError:
                    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 客户端断开连接了，将客户端的监听从input列表中移除  </span>
                    input_list.remove(obj)
                    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 移除客户端对象的消息队列  </span>
                    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">del</span> message_queue[obj]
                    print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"\n[input] Client %s disconnected"</span>%str(addr))

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 如果现在没有客户端请求,也没有客户端发送消息时，开始对发送消息列表进行处理，是否需要发送消息  </span>
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">for</span> sendobj <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> output_list:
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">try</span>:
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 如果消息队列中有消息,从消息队列中获取要发送的消息  </span>
                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">not</span> message_queue[sendobj].empty():
                    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 从该客户端对象的消息队列中获取要发送的消息  </span>
                    send_data = message_queue[sendobj].get()
                    sendobj.send(send_data)
                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
                    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 将监听移除等待下一次客户端发送消息  </span>
                    output_list.remove(sendobj)

            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">except</span> ConnectionResetError:
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 客户端连接断开了  </span>
                <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">del</span> message_queue[sendobj]
                output_list.remove(sendobj)
                print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"\n[output] Client  %s disconnected"</span>%str(addr))</code></pre></div><h4>总结</h4><div><h5 style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; break-after: avoid; margin-top: 1.275em; margin-bottom: 0.85em;">优点</h5><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">select 目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个优点。</p><h5 style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; break-after: avoid; margin-top: 1.275em; margin-bottom: 0.85em;">缺点</h5><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">select 的一个缺点在于单个进程能够监视的文件描述符的数量存在最大限制，在 Linux 上一般为1024，可以通过修改宏定义甚至重新编译内核的方式提升这一限制，但是这样也会造成效率的降低。</p><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">一般来说这个数目和系统内存关系很大，具体数目可以 cat /proc/sys/fs/file-max 察看。32 位机默认是 1024 个。64 位机默认是 2048.</p><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">对 socket 进行扫描时是依次扫描的，即采用轮询的方法，效率较低。</p><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px; margin-bottom: 0px !important;">当套接字比较多的时候，每次 select() 都要通过遍历 FD_SETSIZE 个 Socket 来完成调度，不管哪个 Socket 是活跃的，都遍历一遍。这会浪费很多 CPU 时间。</p></div><h3 id="blogTitle57">单进程服务器 - epoll 版</h3><div><h4 style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; break-after: avoid; margin-top: 1.275em; margin-bottom: 0.85em;">1. epoll的优点：</h4><ol style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; margin: 0px 0px 0.85em; padding: 0px 0px 0px 2em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;"><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">没有最大并发连接的限制，能打开的FD(指的是文件描述符，通俗的理解就是套接字对应的数字编号)的上限远大于1024</li><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">效率提升，不是轮询的方式，不会随着FD数目的增加效率下降。只有活跃可用的FD才会调用callback函数；即epoll最大的优点就在于它只管你“活跃”的连接，而跟连接总数无关，因此在实际的网络环境中，epoll的效率就会远远高于select和poll。</li></ol><h4 style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; break-after: avoid; margin-top: 1.275em; margin-bottom: 0.85em;">2. epoll使用参考代码</h4><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; break-inside: avoid; direction: ltr; border: none; overflow-wrap: normal; margin-top: 0px; margin-bottom: 1.275em; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); white-space: pre-wrap; letter-spacing: 0.2px; font-size: 16px; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; color: rgb(51, 51, 51);"><code class="lang-python" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> socket
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">import</span> select

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 创建套接字</span>
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 设置可以重复使用绑定的信息</span>
s.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1</span>)

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 绑定本机信息</span>
s.bind((<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">""</span>,<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">7788</span>))

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 变为被动</span>
s.listen(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">10</span>)

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 创建一个epoll对象</span>
epoll=select.epoll()

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 测试，用来打印套接字对应的文件描述符</span>
<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># print s.fileno()</span>
<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># print select.EPOLLIN|select.EPOLLET</span>

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 注册事件到epoll中</span>
<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># epoll.register(fd[, eventmask])</span>
<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 注意，如果fd已经注册过，则会发生异常</span>
<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 将创建的套接字添加到epoll的事件监听中</span>
epoll.register(s.fileno(),select.EPOLLIN|select.EPOLLET)


connections = {}
addresses = {}

<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 循环等待客户端的到来或者对方发送数据</span>
<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">while</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">True</span>:

    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># epoll 进行 fd 扫描的地方 -- 未指定超时时间则为阻塞等待</span>
    epoll_list=epoll.poll()

    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 对事件进行判断</span>
    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">for</span> fd,events <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">in</span> epoll_list:

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># print fd</span>
        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># print events</span>

        <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 如果是socket创建的套接字被激活</span>
        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> fd == s.fileno():
            conn,addr=s.accept()

            print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'有新的客户端到来%s'</span>%str(addr))

            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 将 conn 和 addr 信息分别保存起来</span>
            connections[conn.fileno()] = conn
            addresses[conn.fileno()] = addr

            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 向 epoll 中注册 连接 socket 的 可读 事件</span>
            epoll.register(conn.fileno(), select.EPOLLIN | select.EPOLLET)


        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">elif</span> events == select.EPOLLIN:
            <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 从激活 fd 上接收</span>
            recvData = connections[fd].recv(<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">1024</span>)

            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">if</span> len(recvData)&gt;<span class="hljs-number" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(245, 135, 31);">0</span>:
                print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">'recv:%s'</span>%recvData)
            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(137, 89, 168);">else</span>:
                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># 从 epoll 中移除该 连接 fd</span>
                epoll.unregister(fd)

                <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(142, 144, 140);"># server 侧主动关闭该 连接 fd</span>
                connections[fd].close()

                print(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit; color: rgb(113, 140, 0);">"%s---offline---"</span>%str(addresses[fd]))</code></pre><h4 style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; break-after: avoid; margin-top: 1.275em; margin-bottom: 0.85em;">3. 说明</h4><ul style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; margin: 0px 0px 0.85em; padding: 0px 0px 0px 2em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;"><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">EPOLLIN （可读）</li><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">EPOLLOUT （可写）</li><li style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: inherit;">EPOLLET （ET模式）</li></ul><p style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-size: 16px; orphans: 3; widows: 3; margin-top: 0px; margin-bottom: 0.85em; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; letter-spacing: 0.2px;">epoll对文件描述符的操作有两种模式：LT（level trigger）和ET（edge trigger）。LT模式是默认模式，LT模式与ET模式的区别如下：</p><pre style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 16px; white-space: pre-wrap; break-inside: avoid; direction: ltr; border: none; color: rgb(51, 51, 51); overflow-wrap: normal; margin-top: 0px; padding-top: 0.85em; padding-bottom: 0.85em; background-color: rgb(247, 247, 247); letter-spacing: 0.2px; margin-bottom: 0px !important;"><code style="-webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; text-size-adjust: none; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 0.85em; break-inside: avoid; direction: ltr; border: none; color: inherit; padding: 0px; margin: 0px; background: 0px 0px; display: inline; max-width: initial; overflow: initial; line-height: inherit; white-space: pre;">LT模式：当epoll检测到描述符事件发生并将此事件通知应用程序，应用程序可以不立即处理该事件。下次调用epoll时，会再次响应应用程序并通知此事件。

ET模式：当epoll检测到描述符事件发生并将此事件通知应用程序，应用程序必须立即处理该事件。如果不处理，下次调用epoll时，不会再次响应应用程序并通知此事件。</code></pre></div><h3 id="blogTitle58">单进程服务器 - gevent 版</h3><h3 id="blogTitle59">多任务实现 - 协程</h3><h3 id="blogTitle60">协程 - greenlet 版</h3><h3 id="blogTitle61">协程 - gevent 版</h3><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div>
</article>
{% endblock point1 %}
