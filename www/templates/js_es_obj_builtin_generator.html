{% extends 'c-word.html' %}

{% block title %} Web - JS | ES | obj | built-in | generator {% endblock title %}

{% block point1 %}
<div class="tm-main uk-width-medium-3-4" contenteditable="true">
<article class="uk-article">
    <div id="maincontent">
      <div><h3 id="blogTitle0" style="font-family: &quot;Proxima Nova&quot;, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC Regular&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif;"><span style="font-weight: 700; background-color: yellow;">计算机 | 全栈 | 前端 | JS | ES | Obj | Built-in | Generator</span></h3></div><h1 id="blogTitle1"><b>generator</b></h1><div><h3 id="blogTitle2" class="基本概念" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">基本概念</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数是 ES6 提供的一种异步编程解决方案，语法行为与传统函数完全不同。本章详细介绍 Generator 函数的语法和 API，它的异步编程应用请看《Generator 函数的异步应用》一章。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数有多种理解角度。语法上，首先可以把它理解成，Generator 函数是一个状态机，封装了多个内部状态。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">执行 Generator 函数会返回一个遍历器对象，也就是说，Generator 函数除了状态机，还是一个遍历器对象生成函数。返回的遍历器对象，可以依次遍历 Generator 函数内部的每一个状态。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">形式上，Generator 函数是一个普通函数，但是有两个特征。一是，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">function</code>关键字与函数名之间有一个星号；二是，函数体内部使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式，定义不同的内部状态（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>在英语里的意思就是“产出”）。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* helloWorldGenerator() {
  yield 'hello';
  yield 'world';
  return 'ending';
}

var hw = helloWorldGenerator();</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码定义了一个 Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">helloWorldGenerator</code>，它内部有两个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">hello</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">world</code>），即该函数有三个状态：hello，world 和 return 语句（结束执行）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">然后，Generator 函数的调用方法与普通函数一样，也是在函数名后面加上一对圆括号。不同的是，调用 Generator 函数后，该函数并不执行，返回的也不是函数运行结果，而是一个指向内部状态的指针对象，也就是上一章介绍的遍历器对象（Iterator Object）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下一步，必须调用遍历器对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，使得指针移向下一个状态。也就是说，每次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，内部指针就从函数头部或上一次停下来的地方开始执行，直到遇到下一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式（或<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句）为止。换言之，Generator 函数是分段执行的，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式是暂停执行的标记，而<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法可以恢复执行。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">hw.next()
// { value: 'hello', done: false }

hw.next()
// { value: 'world', done: false }

hw.next()
// { value: 'ending', done: true }

hw.next()
// { value: undefined, done: true }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码一共调用了四次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第一次调用，Generator 函数开始执行，直到遇到第一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式为止。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法返回一个对象，它的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性就是当前<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式的值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">hello</code>，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性的值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">false</code>，表示遍历还没有结束。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第二次调用，Generator 函数从上次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式停下的地方，一直执行到下一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法返回的对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性就是当前<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式的值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">world</code>，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性的值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">false</code>，表示遍历还没有结束。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第三次调用，Generator 函数从上次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式停下的地方，一直执行到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句（如果没有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句，就执行到函数结束）。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法返回的对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性，就是紧跟在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句后面的表达式的值（如果没有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句，则<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性的值为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>），<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性的值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>，表示遍历已经结束。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第四次调用，此时 Generator 函数已经运行完毕，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法返回对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>。以后再调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，返回的都是这个值。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">总结一下，调用 Generator 函数，返回一个遍历器对象，代表 Generator 函数的内部指针。以后，每次调用遍历器对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，就会返回一个有着<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>两个属性的对象。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性表示当前的内部状态的值，是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式后面那个表达式的值；<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性是一个布尔值，表示是否遍历结束。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">ES6 没有规定，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">function</code>关键字与函数名之间的星号，写在哪个位置。这导致下面的写法都能通过。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function * foo(x, y) { ··· }
function *foo(x, y) { ··· }
function* foo(x, y) { ··· }
function*foo(x, y) { ··· }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">由于 Generator 函数仍然是普通函数，所以一般的写法是上面的第三种，即星号紧跟在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">function</code>关键字后面。本书也采用这种写法。</p><h3 id="blogTitle3" class="yield-表达式" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">yield 表达式</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">由于 Generator 函数返回的遍历器对象，只有调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法才会遍历下一个内部状态，所以其实提供了一种可以暂停执行的函数。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式就是暂停标志。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">遍历器对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的运行逻辑如下。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（1）遇到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式，就暂停执行后面的操作，并将紧跟在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>后面的那个表达式的值，作为返回的对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性值。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（2）下一次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法时，再继续往下执行，直到遇到下一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（3）如果没有再遇到新的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式，就一直运行到函数结束，直到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句为止，并将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句后面的表达式的值，作为返回的对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性值。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（4）如果该函数没有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句，则返回的对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性值为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">需要注意的是，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式后面的表达式，只有当调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法、内部指针指向该语句时才会执行，因此等于为 JavaScript 提供了手动的“惰性求值”（Lazy Evaluation）的语法功能。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen() {
  yield  123 + 456;
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>后面的表达式<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">123 + 456</code>，不会立即求值，只会在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法将指针移到这一句时，才会求值。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式与<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句既有相似之处，也有区别。相似之处在于，都能返回紧跟在语句后面的那个表达式的值。区别在于每次遇到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>，函数暂停执行，下一次再从该位置继续向后执行，而<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句不具备位置记忆的功能。一个函数里面，只能执行一次（或者说一个）<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句，但是可以执行多次（或者说多个）<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式。正常函数只能返回一个值，因为只能执行一次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>；Generator 函数可以返回一系列的值，因为可以有任意多个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>。从另一个角度看，也可以说 Generator 生成了一系列的值，这也就是它的名称的来历（英语中，generator 这个词是“生成器”的意思）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数可以不用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式，这时就变成了一个单纯的暂缓执行函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* f() {
  console.log('执行了！')
}

var generator = f();

setTimeout(function () {
  generator.next()
}, 2000);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>如果是普通函数，在为变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">generator</code>赋值时就会执行。但是，函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>是一个 Generator 函数，就变成只有调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法时，函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>才会执行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">另外需要注意，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式只能用在 Generator 函数里面，用在其他地方都会报错。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">(function (){
  yield 1;
})()
// SyntaxError: Unexpected number</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码在一个普通函数中使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式，结果产生一个句法错误。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是另外一个例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var arr = [1, [[2, 3], 4], [5, 6]];

var flat = function* (a) {
  a.forEach(function (item) {
    if (typeof item !== 'number') {
      yield* flat(item);
    } else {
      yield item;
    }
  });
};

for (var f of flat(arr)){
  console.log(f);
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码也会产生句法错误，因为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">forEach</code>方法的参数是一个普通函数，但是在里面使用了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式（这个函数里面还使用了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>表达式，详细介绍见后文）。一种修改方法是改用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for</code>循环。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var arr = [1, [[2, 3], 4], [5, 6]];

var flat = function* (a) {
  var length = a.length;
  for (var i = 0; i &lt; length; i++) {
    var item = a[i];
    if (typeof item !== 'number') {
      yield* flat(item);
    } else {
      yield item;
    }
  }
};

for (var f of flat(arr)) {
  console.log(f);
}
// 1, 2, 3, 4, 5, 6</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">另外，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式如果用在另一个表达式之中，必须放在圆括号里面。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* demo() {
  console.log('Hello' + yield); // SyntaxError
  console.log('Hello' + yield 123); // SyntaxError

  console.log('Hello' + (yield)); // OK
  console.log('Hello' + (yield 123)); // OK
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式用作函数参数或放在赋值表达式的右边，可以不加括号。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* demo() {
  foo(yield 'a', yield 'b'); // OK
  let input = yield; // OK
}</code></pre><h3 id="blogTitle4" class="与-Iterator-接口的关系" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">与 Iterator 接口的关系</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上一章说过，任意一个对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.iterator</code>方法，等于该对象的遍历器生成函数，调用该函数会返回该对象的一个遍历器对象。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">由于 Generator 函数就是遍历器生成函数，因此可以把 Generator 赋值给对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.iterator</code>属性，从而使得该对象具有 Iterator 接口。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var myIterable = {};
myIterable[Symbol.iterator] = function* () {
  yield 1;
  yield 2;
  yield 3;
};

[...myIterable] // [1, 2, 3]</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，Generator 函数赋值给<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.iterator</code>属性，从而使得<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">myIterable</code>对象具有了 Iterator 接口，可以被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">...</code>运算符遍历了。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数执行后，返回一个遍历器对象。该对象本身也具有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.iterator</code>属性，执行后返回自身。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen(){
  // some code
}

var g = gen();

g[Symbol.iterator]() === g
// true</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen</code>是一个 Generator 函数，调用它会生成一个遍历器对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>。它的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.iterator</code>属性，也是一个遍历器对象生成函数，执行后返回它自己。</p><h2 id="blogTitle5" class="next-方法的参数" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">next 方法的参数</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式本身没有返回值，或者说总是返回<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法可以带一个参数，该参数就会被当作上一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式的返回值。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* f() {
  for(var i = 0; true; i++) {
    var reset = yield i;
    if(reset) { i = -1; }
  }
}

var g = f();

g.next() // { value: 0, done: false }
g.next() // { value: 1, done: false }
g.next(true) // { value: 0, done: false }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码先定义了一个可以无限运行的 Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>，如果<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法没有参数，每次运行到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式，变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reset</code>的值总是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>。当<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法带一个参数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>时，变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reset</code>就被重置为这个参数（即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>），因此<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">i</code>会等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">-1</code>，下一轮循环就会从<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">-1</code>开始递增。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这个功能有很重要的语法意义。Generator 函数从暂停状态到恢复运行，它的上下文状态（context）是不变的。通过<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的参数，就有办法在 Generator 函数开始运行之后，继续向函数体内部注入值。也就是说，可以在 Generator 函数运行的不同阶段，从外部向内部注入不同的值，从而调整函数行为。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">再看一个例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* foo(x) {
  var y = 2 * (yield (x + 1));
  var z = yield (y / 3);
  return (x + y + z);
}

var a = foo(5);
a.next() // Object{value:6, done:false}
a.next() // Object{value:NaN, done:false}
a.next() // Object{value:NaN, done:true}

var b = foo(5);
b.next() // { value:6, done:false }
b.next(12) // { value:8, done:false }
b.next(13) // { value:42, done:true }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，第二次运行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的时候不带参数，导致 y 的值等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">2 * undefined</code>（即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">NaN</code>），除以 3 以后还是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">NaN</code>，因此返回对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性也等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">NaN</code>。第三次运行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Next</code>方法的时候不带参数，所以<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">z</code>等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>，返回对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">5 + NaN + undefined</code>，即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">NaN</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果向<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法提供参数，返回结果就完全不一样了。上面代码第一次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">b</code>的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法时，返回<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x+1</code>的值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">6</code>；第二次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，将上一次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式的值设为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">12</code>，因此<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">y</code>等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">24</code>，返回<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">y / 3</code>的值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">8</code>；第三次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，将上一次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式的值设为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">13</code>，因此<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">z</code>等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">13</code>，这时<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x</code>等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">5</code>，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">y</code>等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">24</code>，所以<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句的值等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">42</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">注意，由于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的参数表示上一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式的返回值，所以在第一次使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法时，传递参数是无效的。V8 引擎直接忽略第一次使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法时的参数，只有从第二次使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法开始，参数才是有效的。从语义上讲，第一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法用来启动遍历器对象，所以不用带有参数。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">再看一个通过<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的参数，向 Generator 函数内部输入值的例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* dataConsumer() {
  console.log('Started');
  console.log(`1. ${yield}`);
  console.log(`2. ${yield}`);
  return 'result';
}

let genObj = dataConsumer();
genObj.next();
// Started
genObj.next('a')
// 1. a
genObj.next('b')
// 2. b</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码是一个很直观的例子，每次通过<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法向 Generator 函数输入值，然后打印出来。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果想要第一次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法时，就能够输入值，可以在 Generator 函数外面再包一层。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function wrapper(generatorFunction) {
  return function (...args) {
    let generatorObject = generatorFunction(...args);
    generatorObject.next();
    return generatorObject;
  };
}

const wrapped = wrapper(function* () {
  console.log(`First input: ${yield}`);
  return 'DONE';
});

wrapped().next('hello!')
// First input: hello!</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，Generator 函数如果不用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">wrapper</code>先包一层，是无法第一次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，就输入参数的。</p><h2 id="blogTitle6" class="for---of-循环" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">for...of 循环</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环可以自动遍历 Generator 函数时生成的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Iterator</code>对象，且此时不再需要调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function *foo() {
  yield 1;
  yield 2;
  yield 3;
  yield 4;
  yield 5;
  return 6;
}

for (let v of foo()) {
  console.log(v);
}
// 1 2 3 4 5</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环，依次显示 5 个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式的值。这里需要注意，一旦<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的返回对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环就会中止，且不包含该返回对象，所以上面代码的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句返回的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">6</code>，不包括在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环之中。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是一个利用 Generator 函数和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环，实现斐波那契数列的例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* fibonacci() {
  let [prev, curr] = [0, 1];
  for (;;) {
    [prev, curr] = [curr, prev + curr];
    yield curr;
  }
}

for (let n of fibonacci()) {
  if (n &gt; 1000) break;
  console.log(n);
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">从上面代码可见，使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>语句时不需要使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">利用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环，可以写出遍历任意对象（object）的方法。原生的 JavaScript 对象没有遍历接口，无法使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环，通过 Generator 函数为它加上这个接口，就可以用了。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* objectEntries(obj) {
  let propKeys = Reflect.ownKeys(obj);

  for (let propKey of propKeys) {
    yield [propKey, obj[propKey]];
  }
}

let jane = { first: 'Jane', last: 'Doe' };

for (let [key, value] of objectEntries(jane)) {
  console.log(`${key}: ${value}`);
}
// first: Jane
// last: Doe</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">jane</code>原生不具备 Iterator 接口，无法用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>遍历。这时，我们通过 Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">objectEntries</code>为它加上遍历器接口，就可以用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>遍历了。加上遍历器接口的另一种写法是，将 Generator 函数加到对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.iterator</code>属性上面。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* objectEntries() {
  let propKeys = Object.keys(this);

  for (let propKey of propKeys) {
    yield [propKey, this[propKey]];
  }
}

let jane = { first: 'Jane', last: 'Doe' };

jane[Symbol.iterator] = objectEntries;

for (let [key, value] of jane) {
  console.log(`${key}: ${value}`);
}
// first: Jane
// last: Doe</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">除了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环以外，扩展运算符（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">...</code>）、解构赋值和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Array.from</code>方法内部调用的，都是遍历器接口。这意味着，它们都可以将 Generator 函数返回的 Iterator 对象，作为参数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* numbers () {
  yield 1
  yield 2
  return 3
  yield 4
}

// 扩展运算符
[...numbers()] // [1, 2]

// Array.from 方法
Array.from(numbers()) // [1, 2]

// 解构赋值
let [x, y] = numbers();
x // 1
y // 2

// for...of 循环
for (let n of numbers()) {
  console.log(n)
}
// 1
// 2</code></pre><h2 id="blogTitle7" class="Generator-prototype-throw" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator.prototype.throw()</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数返回的遍历器对象，都有一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>方法，可以在函数体外抛出错误，然后在 Generator 函数体内捕获。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var g = function* () {
  try {
    yield;
  } catch (e) {
    console.log('内部捕获', e);
  }
};

var i = g();
i.next();

try {
  i.throw('a');
  i.throw('b');
} catch (e) {
  console.log('外部捕获', e);
}
// 内部捕获 a
// 外部捕获 b</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，遍历器对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">i</code>连续抛出两个错误。第一个错误被 Generator 函数体内的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>语句捕获。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">i</code>第二次抛出错误，由于 Generator 函数内部的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>语句已经执行过了，不会再捕捉到这个错误了，所以这个错误就被抛出了 Generator 函数体，被函数体外的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>语句捕获。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>方法可以接受一个参数，该参数会被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>语句接收，建议抛出<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Error</code>对象的实例。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var g = function* () {
  try {
    yield;
  } catch (e) {
    console.log(e);
  }
};

var i = g();
i.next();
i.throw(new Error('出错了！'));
// Error: 出错了！(…)</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">注意，不要混淆遍历器对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>方法和全局的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>命令。上面代码的错误，是用遍历器对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>方法抛出的，而不是用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>命令抛出的。后者只能被函数体外的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>语句捕获。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var g = function* () {
  while (true) {
    try {
      yield;
    } catch (e) {
      if (e != 'a') throw e;
      console.log('内部捕获', e);
    }
  }
};

var i = g();
i.next();

try {
  throw new Error('a');
  throw new Error('b');
} catch (e) {
  console.log('外部捕获', e);
}
// 外部捕获 [Error: a]</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码之所以只捕获了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">a</code>，是因为函数体外的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>语句块，捕获了抛出的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">a</code>错误以后，就不会再继续<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try</code>代码块里面剩余的语句了。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果 Generator 函数内部没有部署<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块，那么<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>方法抛出的错误，将被外部<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块捕获。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var g = function* () {
  while (true) {
    yield;
    console.log('内部捕获', e);
  }
};

var i = g();
i.next();

try {
  i.throw('a');
  i.throw('b');
} catch (e) {
  console.log('外部捕获', e);
}
// 外部捕获 a</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>内部没有部署<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块，所以抛出的错误直接被外部<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>代码块捕获。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果 Generator 函数内部和外部，都没有部署<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块，那么程序将报错，直接中断执行。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var gen = function* gen(){
  yield console.log('hello');
  yield console.log('world');
}

var g = gen();
g.next();
g.throw();
// hello
// Uncaught undefined</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g.throw</code>抛出错误以后，没有任何<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块可以捕获这个错误，导致程序报错，中断执行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>方法被捕获以后，会附带执行下一条<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式。也就是说，会附带执行一次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var gen = function* gen(){
  try {
    yield console.log('a');
  } catch (e) {
    // ...
  }
  yield console.log('b');
  yield console.log('c');
}

var g = gen();
g.next() // a
g.throw() // b
g.next() // c</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g.throw</code>方法被捕获以后，自动执行了一次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，所以会打印<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">b</code>。另外，也可以看到，只要 Generator 函数内部部署了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块，那么遍历器的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>方法抛出的错误，不影响下一次遍历。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">另外，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>命令与<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g.throw</code>方法是无关的，两者互不影响。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var gen = function* gen(){
  yield console.log('hello');
  yield console.log('world');
}

var g = gen();
g.next();

try {
  throw new Error();
} catch (e) {
  g.next();
}
// hello
// world</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>命令抛出的错误不会影响到遍历器的状态，所以两次执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，都进行了正确的操作。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这种函数体内捕获错误的机制，大大方便了对错误的处理。多个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式，可以只用一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块来捕获错误。如果使用回调函数的写法，想要捕获多个错误，就不得不为每个函数内部写一个错误处理语句，现在只在 Generator 函数内部写一次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>语句就可以了。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数体外抛出的错误，可以在函数体内捕获；反过来，Generator 函数体内抛出的错误，也可以被函数体外的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>捕获。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* foo() {
  var x = yield 3;
  var y = x.toUpperCase();
  yield y;
}

var it = foo();

it.next(); // { value:3, done:false }

try {
  it.next(42);
} catch (err) {
  console.log(err);
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，第二个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法向函数体内传入一个参数 42，数值是没有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">toUpperCase</code>方法的，所以会抛出一个 TypeError 错误，被函数体外的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>捕获。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">一旦 Generator 执行过程中抛出错误，且没有被内部捕获，就不会再执行下去了。如果此后还调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，将返回一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>、<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>的对象，即 JavaScript 引擎认为这个 Generator 已经运行结束了。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* g() {
  yield 1;
  console.log('throwing an exception');
  throw new Error('generator broke!');
  yield 2;
  yield 3;
}

function log(generator) {
  var v;
  console.log('starting generator');
  try {
    v = generator.next();
    console.log('第一次运行next方法', v);
  } catch (err) {
    console.log('捕捉错误', v);
  }
  try {
    v = generator.next();
    console.log('第二次运行next方法', v);
  } catch (err) {
    console.log('捕捉错误', v);
  }
  try {
    v = generator.next();
    console.log('第三次运行next方法', v);
  } catch (err) {
    console.log('捕捉错误', v);
  }
  console.log('caller done');
}

log(g());
// starting generator
// 第一次运行next方法 { value: 1, done: false }
// throwing an exception
// 捕捉错误 { value: 1, done: false }
// 第三次运行next方法 { value: undefined, done: true }
// caller done</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码一共三次运行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，第二次运行的时候会抛出错误，然后第三次运行的时候，Generator 函数就已经结束了，不再执行下去了。</p><h2 id="blogTitle8" class="Generator-prototype-return" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator.prototype.return()</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数返回的遍历器对象，还有一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>方法，可以返回给定的值，并且终结遍历 Generator 函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen() {
  yield 1;
  yield 2;
  yield 3;
}

var g = gen();

g.next()        // { value: 1, done: false }
g.return('foo') // { value: "foo", done: true }
g.next()        // { value: undefined, done: true }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，遍历器对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>方法后，返回值的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性就是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>方法的参数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">foo</code>。并且，Generator 函数的遍历就终止了，返回值的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>，以后再调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性总是返回<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>方法调用时，不提供参数，则返回值的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen() {
  yield 1;
  yield 2;
  yield 3;
}

var g = gen();

g.next()        // { value: 1, done: false }
g.return() // { value: undefined, done: true }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果 Generator 函数内部有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...finally</code>代码块，那么<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>方法会推迟到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">finally</code>代码块执行完再执行。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* numbers () {
  yield 1;
  try {
    yield 2;
    yield 3;
  } finally {
    yield 4;
    yield 5;
  }
  yield 6;
}
var g = numbers();
g.next() // { value: 1, done: false }
g.next() // { value: 2, done: false }
g.return(7) // { value: 4, done: false }
g.next() // { value: 5, done: false }
g.next() // { value: 7, done: true }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>方法后，就开始执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">finally</code>代码块，然后等到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">finally</code>代码块执行完，再执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>方法。</p><h2 id="blogTitle9" class="next、throw、return-的共同点" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">next()、throw()、return() 的共同点</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">网友 vision57 提出，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next()</code>、<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw()</code>、<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return()</code>这三个方法本质上是同一件事，可以放在一起理解。它们的作用都是让 Generator 函数恢复执行，并且使用不同的语句替换<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next()</code>是将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式替换成一个值。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const g = function* (x, y) {
  let result = yield x + y;
  return result;
};

const gen = g(1, 2);
gen.next(); // Object {value: 3, done: false}

gen.next(1); // Object {value: 1, done: true}
// 相当于将 let result = yield x + y
// 替换成 let result = 1;</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，第二个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next(1)</code>方法就相当于将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式替换成一个值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">1</code>。如果<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法没有参数，就相当于替换成<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw()</code>是将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式替换成一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>语句。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">gen.throw(new Error('出错了')); // Uncaught Error: 出错了
// 相当于将 let result = yield x + y
// 替换成 let result = throw(new Error('出错了'));</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return()</code>是将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式替换成一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">gen.return(2); // Object {value: 2, done: true}
// 相当于将 let result = yield x + y
// 替换成 let result = return 2;</code></pre><h2 id="blogTitle10" class="yield--表达式" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">yield* 表达式</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果在 Generator 函数内部，调用另一个 Generator 函数，默认情况下是没有效果的。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* foo() {
  yield 'a';
  yield 'b';
}

function* bar() {
  yield 'x';
  foo();
  yield 'y';
}

for (let v of bar()){
  console.log(v);
}
// "x"
// "y"</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">foo</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">bar</code>都是 Generator 函数，在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">bar</code>里面调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">foo</code>，是不会有效果的。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这个就需要用到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>表达式，用来在一个 Generator 函数里面执行另一个 Generator 函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* bar() {
  yield 'x';
  yield* foo();
  yield 'y';
}

// 等同于
function* bar() {
  yield 'x';
  yield 'a';
  yield 'b';
  yield 'y';
}

// 等同于
function* bar() {
  yield 'x';
  for (let v of foo()) {
    yield v;
  }
  yield 'y';
}

for (let v of bar()){
  console.log(v);
}
// "x"
// "a"
// "b"
// "y"</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">再来看一个对比的例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* inner() {
  yield 'hello!';
}

function* outer1() {
  yield 'open';
  yield inner();
  yield 'close';
}

var gen = outer1()
gen.next().value // "open"
gen.next().value // 返回一个遍历器对象
gen.next().value // "close"

function* outer2() {
  yield 'open'
  yield* inner()
  yield 'close'
}

var gen = outer2()
gen.next().value // "open"
gen.next().value // "hello!"
gen.next().value // "close"</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面例子中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">outer2</code>使用了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">outer1</code>没使用。结果就是，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">outer1</code>返回一个遍历器对象，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">outer2</code>返回该遍历器对象的内部值。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">从语法角度看，如果<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式后面跟的是一个遍历器对象，需要在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式后面加上星号，表明它返回的是一个遍历器对象。这被称为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>表达式。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">let delegatedIterator = (function* () {
  yield 'Hello!';
  yield 'Bye!';
}());

let delegatingIterator = (function* () {
  yield 'Greetings!';
  yield* delegatedIterator;
  yield 'Ok, bye.';
}());

for(let value of delegatingIterator) {
  console.log(value);
}
// "Greetings!
// "Hello!"
// "Bye!"
// "Ok, bye."</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">delegatingIterator</code>是代理者，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">delegatedIterator</code>是被代理者。由于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield* delegatedIterator</code>语句得到的值，是一个遍历器，所以要用星号表示。运行结果就是使用一个遍历器，遍历了多个 Generator 函数，有递归的效果。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>后面的 Generator 函数（没有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句时），等同于在 Generator 函数内部，部署一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* concat(iter1, iter2) {
  yield* iter1;
  yield* iter2;
}

// 等同于

function* concat(iter1, iter2) {
  for (var value of iter1) {
    yield value;
  }
  for (var value of iter2) {
    yield value;
  }
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码说明，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>后面的 Generator 函数（没有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句时），不过是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>的一种简写形式，完全可以用后者替代前者。反之，在有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句时，则需要用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">var value = yield* iterator</code>的形式获取<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句的值。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>后面跟着一个数组，由于数组原生支持遍历器，因此就会遍历数组成员。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen(){
  yield* ["a", "b", "c"];
}

gen().next() // { value:"a", done:false }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令后面如果不加星号，返回的是整个数组，加了星号就表示返回的是数组的遍历器对象。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">实际上，任何数据结构只要有 Iterator 接口，就可以被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>遍历。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">let read = (function* () {
  yield 'hello';
  yield* 'hello';
})();

read.next().value // "hello"
read.next().value // "h"</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式返回整个字符串，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>语句返回单个字符。因为字符串具有 Iterator 接口，所以被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>遍历。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果被代理的 Generator 函数有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句，那么就可以向代理它的 Generator 函数返回数据。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function *foo() {
  yield 2;
  yield 3;
  return "foo";
}

function *bar() {
  yield 1;
  var v = yield *foo();
  console.log( "v: " + v );
  yield 4;
}

var it = bar();

it.next()
// {value: 1, done: false}
it.next()
// {value: 2, done: false}
it.next()
// {value: 3, done: false}
it.next();
// "v: foo"
// {value: 4, done: false}
it.next()
// {value: undefined, done: true}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码在第四次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的时候，屏幕上会有输出，这是因为函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">foo</code>的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句，向函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">bar</code>提供了返回值。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">再看一个例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* genFuncWithReturn() {
  yield 'a';
  yield 'b';
  return 'The result';
}
function* logReturned(genObj) {
  let result = yield* genObj;
  console.log(result);
}

[...logReturned(genFuncWithReturn())]
// The result
// 值为 [ 'a', 'b' ]</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，存在两次遍历。第一次是扩展运算符遍历函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">logReturned</code>返回的遍历器对象，第二次是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>语句遍历函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">genFuncWithReturn</code>返回的遍历器对象。这两次遍历的效果是叠加的，最终表现为扩展运算符遍历函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">genFuncWithReturn</code>返回的遍历器对象。所以，最后的数据表达式得到的值等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">[ 'a', 'b' ]</code>。但是，函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">genFuncWithReturn</code>的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句的返回值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">The result</code>，会返回给函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">logReturned</code>内部的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">result</code>变量，因此会有终端输出。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>命令可以很方便地取出嵌套数组的所有成员。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* iterTree(tree) {
  if (Array.isArray(tree)) {
    for(let i=0; i &lt; tree.length; i++) {
      yield* iterTree(tree[i]);
    }
  } else {
    yield tree;
  }
}

const tree = [ 'a', ['b', 'c'], ['d', 'e'] ];

for(let x of iterTree(tree)) {
  console.log(x);
}
// a
// b
// c
// d
// e</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是一个稍微复杂的例子，使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>语句遍历完全二叉树。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">// 下面是二叉树的构造函数，
// 三个参数分别是左树、当前节点和右树
function Tree(left, label, right) {
  this.left = left;
  this.label = label;
  this.right = right;
}

// 下面是中序（inorder）遍历函数。
// 由于返回的是一个遍历器，所以要用generator函数。
// 函数体内采用递归算法，所以左树和右树要用yield*遍历
function* inorder(t) {
  if (t) {
    yield* inorder(t.left);
    yield t.label;
    yield* inorder(t.right);
  }
}

// 下面生成二叉树
function make(array) {
  // 判断是否为叶节点
  if (array.length == 1) return new Tree(null, array[0], null);
  return new Tree(make(array[0]), array[1], make(array[2]));
}
let tree = make([[['a'], 'b', ['c']], 'd', [['e'], 'f', ['g']]]);

// 遍历二叉树
var result = [];
for (let node of inorder(tree)) {
  result.push(node);
}

result
// ['a', 'b', 'c', 'd', 'e', 'f', 'g']</code></pre><h2 id="blogTitle11" class="作为对象属性的-Generator-函数" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">作为对象属性的 Generator 函数</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果一个对象的属性是 Generator 函数，可以简写成下面的形式。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">let obj = {
  * myGeneratorMethod() {
    ···
  }
};</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">myGeneratorMethod</code>属性前面有一个星号，表示这个属性是一个 Generator 函数。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">它的完整形式如下，与上面的写法是等价的。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">let obj = {
  myGeneratorMethod: function* () {
    // ···
  }
};</code></pre><h2 id="blogTitle12" class="Generator-函数的this" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator 函数的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">this</code></h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数总是返回一个遍历器，ES6 规定这个遍历器是 Generator 函数的实例，也继承了 Generator 函数的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">prototype</code>对象上的方法。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* g() {}

g.prototype.hello = function () {
  return 'hi!';
};

let obj = g();

obj instanceof g // true
obj.hello() // 'hi!'</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码表明，Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>返回的遍历器<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">obj</code>，是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>的实例，而且继承了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g.prototype</code>。但是，如果把<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>当作普通的构造函数，并不会生效，因为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>返回的总是遍历器对象，而不是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">this</code>对象。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* g() {
  this.a = 11;
}

let obj = g();
obj.a // undefined</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">this</code>对象上面添加了一个属性<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">a</code>，但是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">obj</code>对象拿不到这个属性。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数也不能跟<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">new</code>命令一起用，会报错。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* F() {
  yield this.x = 2;
  yield this.y = 3;
}

new F()
// TypeError: F is not a constructor</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">new</code>命令跟构造函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">F</code>一起使用，结果报错，因为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">F</code>不是构造函数。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">那么，有没有办法让 Generator 函数返回一个正常的对象实例，既可以用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，又可以获得正常的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">this</code>？</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是一个变通方法。首先，生成一个空对象，使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">call</code>方法绑定 Generator 函数内部的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">this</code>。这样，构造函数调用以后，这个空对象就是 Generator 函数的实例对象了。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* F() {
  this.a = 1;
  yield this.b = 2;
  yield this.c = 3;
}
var obj = {};
var f = F.call(obj);

f.next();  // Object {value: 2, done: false}
f.next();  // Object {value: 3, done: false}
f.next();  // Object {value: undefined, done: true}

obj.a // 1
obj.b // 2
obj.c // 3</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，首先是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">F</code>内部的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">this</code>对象绑定<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">obj</code>对象，然后调用它，返回一个 Iterator 对象。这个对象执行三次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法（因为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">F</code>内部有两个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式），完成 F 内部所有代码的运行。这时，所有内部属性都绑定在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">obj</code>对象上了，因此<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">obj</code>对象也就成了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">F</code>的实例。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，执行的是遍历器对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>，但是生成的对象实例是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">obj</code>，有没有办法将这两个对象统一呢？</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">一个办法就是将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">obj</code>换成<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">F.prototype</code>。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* F() {
  this.a = 1;
  yield this.b = 2;
  yield this.c = 3;
}
var f = F.call(F.prototype);

f.next();  // Object {value: 2, done: false}
f.next();  // Object {value: 3, done: false}
f.next();  // Object {value: undefined, done: true}

f.a // 1
f.b // 2
f.c // 3</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">再将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">F</code>改成构造函数，就可以对它执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">new</code>命令了。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen() {
  this.a = 1;
  yield this.b = 2;
  yield this.c = 3;
}

function F() {
  return gen.call(gen.prototype);
}

var f = new F();

f.next();  // Object {value: 2, done: false}
f.next();  // Object {value: 3, done: false}
f.next();  // Object {value: undefined, done: true}

f.a // 1
f.b // 2
f.c // 3</code></pre><h2 id="blogTitle13" class="含义" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">含义</h2><h3 id="blogTitle14" class="Generator-与状态机" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator 与状态机</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 是实现状态机的最佳结构。比如，下面的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">clock</code>函数就是一个状态机。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var ticking = true;
var clock = function() {
  if (ticking)
    console.log('Tick!');
  else
    console.log('Tock!');
  ticking = !ticking;
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">clock</code>函数一共有两种状态（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Tick</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Tock</code>），每运行一次，就改变一次状态。这个函数如果用 Generator 实现，就是下面这样。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var clock = function* () {
  while (true) {
    console.log('Tick!');
    yield;
    console.log('Tock!');
    yield;
  }
};</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面的 Generator 实现与 ES5 实现对比，可以看到少了用来保存状态的外部变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">ticking</code>，这样就更简洁，更安全（状态不会被非法篡改）、更符合函数式编程的思想，在写法上也更优雅。Generator 之所以可以不用外部变量保存状态，是因为它本身就包含了一个状态信息，即目前是否处于暂停态。</p><h3 id="blogTitle15" class="Generator-与协程" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator 与协程</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">协程（coroutine）是一种程序运行的方式，可以理解成“协作的线程”或“协作的函数”。协程既可以用单线程实现，也可以用多线程实现。前者是一种特殊的子例程，后者是一种特殊的线程。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><strong>（1）协程与子例程的差异</strong></p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">传统的“子例程”（subroutine）采用堆栈式“后进先出”的执行方式，只有当调用的子函数完全执行完毕，才会结束执行父函数。协程与其不同，多个线程（单线程情况下，即多个函数）可以并行执行，但是只有一个线程（或函数）处于正在运行的状态，其他线程（或函数）都处于暂停态（suspended），线程（或函数）之间可以交换执行权。也就是说，一个线程（或函数）执行到一半，可以暂停执行，将执行权交给另一个线程（或函数），等到稍后收回执行权的时候，再恢复执行。这种可以并行执行、交换执行权的线程（或函数），就称为协程。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">从实现上看，在内存中，子例程只使用一个栈（stack），而协程是同时存在多个栈，但只有一个栈是在运行状态，也就是说，协程是以多占用内存为代价，实现多任务的并行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><strong>（2）协程与普通线程的差异</strong></p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">不难看出，协程适合用于多任务运行的环境。在这个意义上，它与普通的线程很相似，都有自己的执行上下文、可以分享全局变量。它们的不同之处在于，同一时间可以有多个线程处于运行状态，但是运行的协程只能有一个，其他协程都处于暂停状态。此外，普通的线程是抢先式的，到底哪个线程优先得到资源，必须由运行环境决定，但是协程是合作式的，执行权由协程自己分配。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">由于 JavaScript 是单线程语言，只能保持一个调用栈。引入协程以后，每个任务可以保持自己的调用栈。这样做的最大好处，就是抛出错误的时候，可以找到原始的调用栈。不至于像异步操作的回调函数那样，一旦出错，原始的调用栈早就结束。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数是 ES6 对协程的实现，但属于不完全实现。Generator 函数被称为“半协程”（semi-coroutine），意思是只有 Generator 函数的调用者，才能将程序的执行权还给 Generator 函数。如果是完全执行的协程，任何函数都可以让暂停的协程继续执行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果将 Generator 函数当作协程，完全可以将多个需要互相协作的任务写成 Generator 函数，它们之间使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表示式交换控制权。</p><h3 id="blogTitle16" class="Generator-与上下文" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator 与上下文</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">JavaScript 代码运行时，会产生一个全局的上下文环境（context，又称运行环境），包含了当前所有的变量和对象。然后，执行函数（或块级代码）的时候，又会在当前上下文环境的上层，产生一个函数运行的上下文，变成当前（active）的上下文，由此形成一个上下文环境的堆栈（context stack）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这个堆栈是“后进先出”的数据结构，最后产生的上下文环境首先执行完成，退出堆栈，然后再执行完成它下层的上下文，直至所有代码执行完成，堆栈清空。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数不是这样，它执行产生的上下文环境，一旦遇到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令，就会暂时退出堆栈，但是并不消失，里面的所有变量和对象会冻结在当前状态。等到对它执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>命令时，这个上下文环境又会重新加入调用栈，冻结的变量和对象恢复执行。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function *gen() {
  yield 1;
  return 2;
}

let g = gen();

console.log(
  g.next().value,
  g.next().value,
);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，第一次执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g.next()</code>时，Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen</code>的上下文会加入堆栈，即开始运行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen</code>内部的代码。等遇到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield 1</code>时，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen</code>上下文退出堆栈，内部状态冻结。第二次执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g.next()</code>时，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen</code>上下文重新加入堆栈，变成当前的上下文，重新恢复执行。</p><h2 id="blogTitle17" class="应用" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">应用</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 可以暂停函数执行，返回任意表达式的值。这种特点使得 Generator 有多种应用场景。</p><h3 id="blogTitle18" class="（1）异步操作的同步化表达" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">（1）异步操作的同步化表达</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数的暂停执行的效果，意味着可以把异步操作写在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式里面，等到调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法时再往后执行。这实际上等同于不需要写回调函数了，因为异步操作的后续操作可以放在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式下面，反正要等到调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法时再执行。所以，Generator 函数的一个重要实际意义就是用来处理异步操作，改写回调函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* loadUI() {
  showLoadingScreen();
  yield loadUIDataAsynchronously();
  hideLoadingScreen();
}
var loader = loadUI();
// 加载UI
loader.next()

// 卸载UI
loader.next()</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，第一次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">loadUI</code>函数时，该函数不会执行，仅返回一个遍历器。下一次对该遍历器调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，则会显示<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Loading</code>界面（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">showLoadingScreen</code>），并且异步加载数据（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">loadUIDataAsynchronously</code>）。等到数据加载完成，再一次使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，则会隐藏<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Loading</code>界面。可以看到，这种写法的好处是所有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Loading</code>界面的逻辑，都被封装在一个函数，按部就班非常清晰。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Ajax 是典型的异步操作，通过 Generator 函数部署 Ajax 操作，可以用同步的方式表达。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* main() {
  var result = yield request("http://some.url");
  var resp = JSON.parse(result);
    console.log(resp.value);
}

function request(url) {
  makeAjaxCall(url, function(response){
    it.next(response);
  });
}

var it = main();
it.next();</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">main</code>函数，就是通过 Ajax 操作获取数据。可以看到，除了多了一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>，它几乎与同步操作的写法完全一样。注意，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">makeAjaxCall</code>函数中的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，必须加上<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">response</code>参数，因为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式，本身是没有值的，总是等于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">undefined</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是另一个例子，通过 Generator 函数逐行读取文本文件。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* numbers() {
  let file = new FileReader("numbers.txt");
  try {
    while(!file.eof) {
      yield parseInt(file.readLine(), 10);
    }
  } finally {
    file.close();
  }
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码打开文本文件，使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>表达式可以手动逐行读取文件。</p><h3 id="blogTitle19" class="（2）控制流管理" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">（2）控制流管理</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果有一个多步操作非常耗时，采用回调函数，可能会写成下面这样。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">step1(function (value1) {
  step2(value1, function(value2) {
    step3(value2, function(value3) {
      step4(value3, function(value4) {
        // Do something with value4
      });
    });
  });
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">采用 Promise 改写上面的代码。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">Promise.resolve(step1)
  .then(step2)
  .then(step3)
  .then(step4)
  .then(function (value4) {
    // Do something with value4
  }, function (error) {
    // Handle any error from step1 through step4
  })
  .done();</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码已经把回调函数，改成了直线执行的形式，但是加入了大量 Promise 的语法。Generator 函数可以进一步改善代码运行流程。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* longRunningTask(value1) {
  try {
    var value2 = yield step1(value1);
    var value3 = yield step2(value2);
    var value4 = yield step3(value3);
    var value5 = yield step4(value4);
    // Do something with value4
  } catch (e) {
    // Handle any error from step1 through step4
  }
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">然后，使用一个函数，按次序自动执行所有步骤。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">scheduler(longRunningTask(initialValue));

function scheduler(task) {
  var taskObj = task.next(task.value);
  // 如果Generator函数未结束，就继续调用
  if (!taskObj.done) {
    task.value = taskObj.value
    scheduler(task);
  }
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">注意，上面这种做法，只适合同步操作，即所有的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">task</code>都必须是同步的，不能有异步操作。因为这里的代码一得到返回值，就继续往下执行，没有判断异步操作何时完成。如果要控制异步的操作流程，详见后面的《异步操作》一章。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面，利用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环会自动依次执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令的特性，提供一种更一般的控制流管理的方法。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">let steps = [step1Func, step2Func, step3Func];

function *iterateSteps(steps){
  for (var i=0; i&lt; steps.length; i++){
    var step = steps[i];
    yield step();
  }
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，数组<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">steps</code>封装了一个任务的多个步骤，Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">iterateSteps</code>则是依次为这些步骤加上<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">将任务分解成步骤之后，还可以将项目分解成多个依次执行的任务。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">let jobs = [job1, job2, job3];

function* iterateJobs(jobs){
  for (var i=0; i&lt; jobs.length; i++){
    var job = jobs[i];
    yield* iterateSteps(job.steps);
  }
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，数组<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">jobs</code>封装了一个项目的多个任务，Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">iterateJobs</code>则是依次为这些任务加上<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>命令。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">最后，就可以用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环一次性依次执行所有任务的所有步骤。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">for (var step of iterateJobs(jobs)){
  console.log(step.id);
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">再次提醒，上面的做法只能用于所有步骤都是同步操作的情况，不能有异步操作的步骤。如果想要依次执行异步的步骤，必须使用后面的《异步操作》一章介绍的方法。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>的本质是一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">while</code>循环，所以上面的代码实质上执行的是下面的逻辑。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var it = iterateJobs(jobs);
var res = it.next();

while (!res.done){
  var result = res.value;
  // ...
  res = it.next();
}</code></pre><h3 id="blogTitle20" class="（3）部署-Iterator-接口" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">（3）部署 Iterator 接口</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">利用 Generator 函数，可以在任意对象上部署 Iterator 接口。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* iterEntries(obj) {
  let keys = Object.keys(obj);
  for (let i=0; i &lt; keys.length; i++) {
    let key = keys[i];
    yield [key, obj[key]];
  }
}

let myObj = { foo: 3, bar: 7 };

for (let [key, value] of iterEntries(myObj)) {
  console.log(key, value);
}

// foo 3
// bar 7</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上述代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">myObj</code>是一个普通对象，通过<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">iterEntries</code>函数，就有了 Iterator 接口。也就是说，可以在任意对象上部署<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是一个对数组部署 Iterator 接口的例子，尽管数组原生具有这个接口。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* makeSimpleGenerator(array){
  var nextIndex = 0;

  while(nextIndex &lt; array.length){
    yield array[nextIndex++];
  }
}

var gen = makeSimpleGenerator(['yo', 'ya']);

gen.next().value // 'yo'
gen.next().value // 'ya'
gen.next().done  // true</code></pre><h3 id="blogTitle21" class="（4）作为数据结构" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">（4）作为数据结构</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 可以看作是数据结构，更确切地说，可以看作是一个数组结构，因为 Generator 函数可以返回一系列的值，这意味着它可以对任意表达式，提供类似数组的接口。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function *doStuff() {
  yield fs.readFile.bind(null, 'hello.txt');
  yield fs.readFile.bind(null, 'world.txt');
  yield fs.readFile.bind(null, 'and-such.txt');
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码就是依次返回三个函数，但是由于使用了 Generator 函数，导致可以像处理数组那样，处理这三个返回的函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">for (task of doStuff()) {
  // task是一个函数，可以像回调函数那样使用它
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">实际上，如果用 ES5 表达，完全可以用数组模拟 Generator 的这种用法。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function doStuff() {
  return [
    fs.readFile.bind(null, 'hello.txt'),
    fs.readFile.bind(null, 'world.txt'),
    fs.readFile.bind(null, 'and-such.txt')
  ];
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面的函数，可以用一模一样的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环处理！两相一比较，就不难看出 Generator 使得数据或者操作，具备了类似数组的接口。</p></div><div><h1 id="blogTitle22" style="margin-top: 25px; font-family: &quot;Proxima Nova&quot;, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC Regular&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif;"><b>Generator 对象</b></h1><div style=""><p style="color: rgb(102, 102, 102); font-weight: inherit; margin-bottom: 24px; padding: 0px; border: 0px;"><span style="border-style: initial; border-color: initial; border-image: initial;">生成器</span>对象是由一个&nbsp;<a title="function* 声明 (function关键字后跟一个星号）定义了一个生成器函数 (generator function)，它返回一个 &nbsp;Generator&nbsp;&nbsp;对象。" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/function*" style="margin: 0px; padding: 0px; border: 0px;">generator function</a>&nbsp;返回的,并且它符合<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols#iterable" style="margin: 0px; padding: 0px; border: 0px;">可迭代协议</a>和<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols#iterator" style="margin: 0px; padding: 0px; border: 0px;">迭代器协议</a>。</p><h4 style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-bottom: 12px; font-family: &quot;Proxima Nova&quot;, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC Regular&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif; line-height: 1; word-wrap: break-word; padding: 0px; border: 0px;"><span style="font-weight: 700;">语法</span></h4><pre class="syntaxbox" style="color: rgb(59, 60, 64); font-weight: inherit; margin-top: 0px; margin-bottom: 20px; padding: 15px; background-color: rgb(221, 228, 233); font-size: 15px; line-height: 19px; font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; border-width: 0px 0px 0px 5px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(85, 138, 187); direction: ltr; hyphens: none; white-space: pre-wrap;">function* gen() { 
  yield 1;
  yield 2;
  yield 3;
}

let g = gen(); 
// "Generator { }"</pre><h4 style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-bottom: 12px; font-family: &quot;Proxima Nova&quot;, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC Regular&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif; line-height: 1; word-wrap: break-word; padding: 0px; border: 0px;"><span style="font-weight: 700;"><br></span></h4><h1 style="color: rgb(102, 102, 102); margin-top: 0px; margin-bottom: 12px; font-family: &quot;Proxima Nova&quot;, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC Regular&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif; line-height: 1; word-wrap: break-word; padding: 0px; border: 0px;" id="blogTitle23"><b>Generator 对象原型</b></h1><h2 style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-bottom: 12px; font-family: &quot;Proxima Nova&quot;, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC Regular&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif; line-height: 1; word-wrap: break-word; padding: 0px; border: 0px;" id="blogTitle24"><span style="font-weight: 700;">方法</span></h2><dl style="margin-top: 0px; margin-bottom: 20px; padding: 0px; border: 0px;"><dt style="color: rgb(102, 102, 102); font-weight: inherit; cursor: pointer; margin: 0px; padding: 0px; border: 0px;"><a title="next() 方法返回一个包含属性 done 和 value 的对象。该方法也可以通过接受一个参数用以向生成器传值。" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator/next" style="margin: 0px; padding: 0px; border: 0px;"><font face="consolas, Liberation Mono, courier, monospace"><span style="border-style: initial; border-color: initial; font-weight: inherit; font-style: inherit;">Generator.prototype.next()</span></font></a></dt><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;">返回一个由&nbsp;<a title="yield 关键字用来暂停和恢复一个生成器函数 ( (function* 或 legacy generator)." href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/yield" style="margin: 0px; padding: 0px; border: 0px;"><font face="consolas, Liberation Mono, courier, monospace"><span style="border-style: initial; border-color: initial; font-weight: inherit; font-style: inherit;">yield</span></font></a>表达式生成的值。</dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><code style="margin: 0px; padding: 0px 2px; border: 0px; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(51, 51, 51); font-size: medium; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px;">next</strong></code><strong style="margin: 0px; padding: 0px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">()</code></strong><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">&nbsp;方法返回一个包含属性&nbsp;</span><code style="margin: 0px; padding: 0px 2px; border: 0px; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(51, 51, 51); font-size: medium; white-space: normal;">done</code><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">&nbsp;和&nbsp;</span><code style="margin: 0px; padding: 0px 2px; border: 0px; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(51, 51, 51); font-size: medium; white-space: normal;">value</code><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">&nbsp;的对象。该方法也可以通过接受一个参数用以向生成器传值。</span><br></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><pre class="syntaxbox" style="margin-bottom: 20px; padding: 15px; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(228, 240, 245); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; white-space: pre-wrap; border-right-width: 0px !important; border-left-width: 5px !important;"><code style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">gen.next(value)</code></pre></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"></dd><dt style="margin: 0px; padding: 0px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">value</code></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">向生成器传递的值.</dd><dd style="color: rgb(102, 102, 102); margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><b>返回值</b></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><p style="margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">返回的<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;">对象</a></code>包含两个属性:</p><ul style="list-style-position: initial; list-style-image: initial; margin-top: 0px; margin-bottom: 24px; padding: 0px 0px 0px 40px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><li style="margin: 0px 0px 6px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">done</code>&nbsp;(布尔类型)<ul style="list-style-position: initial; list-style-image: initial; padding: 6px 0px 0px 40px; border: 0px; box-sizing: border-box; max-width: 42rem;"><li style="margin: 0px 0px 6px; padding: 0px; border: 0px;">当迭代器遍历到迭代序列末端时返回值&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">true</code>。此时，迭代器可以将返回值作为&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">value</code>。</li><li style="margin: 0px 0px 6px; padding: 0px; border: 0px;">当迭代器仍可继续在迭代序列中向前遍历时返回值&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">false。</code>这相当于不指定&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">done&nbsp;</code>属性。</li></ul></li><li style="margin: 0px 0px 6px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">value</code>&nbsp;- 迭代器返回的任意的Javascript值。当&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">done</code>&nbsp;的值为&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">true&nbsp;</code>时可以忽略该值。</li></ul></dd><dd style="color: rgb(102, 102, 102); margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><b>示例</b></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><p style="margin-top: 20px; margin-bottom: 20px; padding: 0px; border: 0px; font-size: 1.5rem; font-family: Palatino, &quot;Palatino Linotype&quot;, x-locale-heading-secondary, serif; line-height: 1.25; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); -webkit-box-decoration-break: clone;"><span class="highlight-span" style="margin: 0px; padding: 0px 4px 0px 40px; border: 0px; background-color: rgb(51, 51, 51); color: rgb(255, 255, 255); line-height: 1.25; -webkit-box-decoration-break: clone;">使用&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(255, 255, 255, 0.4) !important; border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(255, 255, 255) !important;">next()方法</code></span></p><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">下面的例子展示了一个简单的生成器, 以及调用&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">next</code>&nbsp;后方法的返回值:</p><pre class="brush: js line-numbers  language-js" style="margin-top: 0px; margin-bottom: 20px; padding: 15px 15px 15px 3.8em; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1.5; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; text-shadow: none; word-break: normal; word-wrap: normal; counter-reset: linenumber 0; border-right-width: 0px !important; border-left-width: 5px !important;"><code class=" language-js" style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; word-wrap: normal; text-shadow: none; direction: ltr; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; position: relative;">function* gen() { 
  yield 1;
  yield 2;
  yield 3;
}

var g = gen(); // "Generator { }"
g.next();      // "Object { value: 1, done: false }"
g.next();      // "Object { value: 2, done: false }"
g.next();      // "Object { value: 3, done: false }"
g.next();      // "Object { value: undefined, done: true }"</code></pre><p style="margin-top: 20px; margin-bottom: 20px; padding: 0px; border: 0px; font-size: 1.5rem; font-family: Palatino, &quot;Palatino Linotype&quot;, x-locale-heading-secondary, serif; line-height: 1.25; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); -webkit-box-decoration-break: clone;"><span class="highlight-span" style="margin: 0px; padding: 0px 4px 0px 40px; border: 0px; background-color: rgb(51, 51, 51); color: rgb(255, 255, 255); line-height: 1.25; -webkit-box-decoration-break: clone;">向生成器传值</span></p><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">在该示例中，调用&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">next</code>&nbsp;方法并传入了参数，请注意，首次调用&nbsp;<code style="margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">next</code>&nbsp;方法时没有出任何输出, 这是因为初始状态时生成器通过<span style="margin: 0px; padding: 0px; border: 0px; font-family: courier, &quot;andale mono&quot;, monospace;">yield</span>&nbsp;返回了null.</p><pre class="brush: js line-numbers  language-js" style="margin-top: 0px; margin-bottom: 20px; padding: 15px 15px 15px 3.8em; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1.5; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; text-shadow: none; word-break: normal; word-wrap: normal; counter-reset: linenumber 0; border-right-width: 0px !important; border-left-width: 5px !important;"><code class=" language-js" style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; word-wrap: normal; text-shadow: none; direction: ltr; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; position: relative;">function* gen() {
  while(true) {
    var value = yield null;
    console.log(value);
  }
}

var g = gen();
g.next(1); 
// "{ value: null, done: false }"
g.next(2); 
// "{ value: null, done: false }"
// 2</code></pre></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><br></dd><dt style="color: rgb(102, 102, 102); font-weight: inherit; cursor: pointer; margin: 0px; padding: 0px; border: 0px;"><a title="return() 方法返回给定的值并结束生成器。" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator/return" style="margin: 0px; padding: 0px; border: 0px;"><font face="consolas, Liberation Mono, courier, monospace"><span style="border-style: initial; border-color: initial; font-weight: inherit; font-style: inherit;">Generator.prototype.return()</span></font></a></dt><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;">返回给定的值并结束生成器。</dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><pre class="syntaxbox" style="margin-bottom: 20px; padding: 15px; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(228, 240, 245); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; white-space: pre-wrap; border-right-width: 0px !important; border-left-width: 5px !important;"><code style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">gen.return(value)</code></pre></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"></dd><dt style="margin: 0px; padding: 0px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">value</code></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">需要返回的值</dd><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><p style="margin-top: 20px; margin-bottom: 20px; padding: 0px; border: 0px; line-height: 1.25; -webkit-box-decoration-break: clone;"><span class="highlight-span" style="margin: 0px; padding: 0px 4px 0px 40px; border: 0px; line-height: 1.25; -webkit-box-decoration-break: clone;"><b>使用&nbsp;<span style="padding-right: 2px; padding-left: 2px; border-style: initial; border-color: initial; border-image: initial; border-radius: 2px;">return()</span></b></span></p><p style="color: rgb(51, 51, 51); font-weight: inherit; margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">以下例子展示了一个简单的生成器和&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">return</code>&nbsp;方法的使用.</p><pre class="brush: js line-numbers  language-js" style="color: rgb(51, 51, 51); font-weight: inherit; margin-top: 0px; margin-bottom: 20px; padding: 15px 15px 15px 3.8em; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(238, 238, 238); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1.5; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; text-shadow: none; word-break: normal; word-wrap: normal; counter-reset: linenumber 0; border-right-width: 0px !important; border-left-width: 5px !important;"><code class=" language-js" style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; word-wrap: normal; text-shadow: none; direction: ltr; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; position: relative;">function* gen() { 
  yield 1;
  yield 2;
  yield 3;
}

var g = gen();

g.next();        // { value: 1, done: false }
g.return("foo"); // { value: "foo", done: true }
g.next();        // { value: undefined, done: true }</code></pre><p style="margin-top: 103px; margin-bottom: 20px; padding: 0px; border: 0px; line-height: 1.2; position: relative;"><b>注意</b></p><p style="color: rgb(51, 51, 51); font-weight: inherit; margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">如果生成器已经结束，<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">return(value)&nbsp;会和上次的&nbsp;</code>next() 一样，value 为&nbsp;undefined.</p><pre style="color: rgb(51, 51, 51); font-weight: inherit; margin-top: 0px; margin-bottom: 20px; padding: 15px; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(238, 238, 238); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1.5; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; border-right-width: 0px !important; border-left-width: 5px !important;"><code style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">function* gen() {yield 1;}
var g = gen();
console.log(g.next());//{ value: 1, done: false }
console.log(g.next());//{ value: undefined, done: true }
console.log(g.return(1)); //{ value: 1, done: true }</code></pre></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><br></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><br></dd><dt style="color: rgb(102, 102, 102); font-weight: inherit; cursor: pointer; margin: 0px; padding: 0px; border: 0px;"><a title="throw() 方法用来向生成器抛出异常，并恢复生成器的执行，返回带有 done 及 value 两个属性的对象。" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator/throw" style="margin: 0px; padding: 0px; border: 0px;"><font face="consolas, Liberation Mono, courier, monospace"><span style="border-style: initial; border-color: initial; font-weight: inherit; font-style: inherit;">Generator.prototype.throw()</span></font></a></dt><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;">向生成器抛出一个错误。</dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><code style="margin: 0px; padding: 0px 2px; border: 0px; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(51, 51, 51); font-size: medium; white-space: normal;"><strong style="margin: 0px; padding: 0px; border: 0px;">throw</strong></code><strong style="margin: 0px; padding: 0px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">()</code></strong><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">&nbsp;方法用来向生成器抛出异常，并恢复生成器的执行，返回带有&nbsp;</span><code style="margin: 0px; padding: 0px 2px; border: 0px; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(51, 51, 51); font-size: medium; white-space: normal;">done</code><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">&nbsp;及&nbsp;</span><code style="margin: 0px; padding: 0px 2px; border: 0px; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(51, 51, 51); font-size: medium; white-space: normal;">value</code><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">两个属性的对象。</span><br></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><pre class="syntaxbox" style="margin-bottom: 20px; padding: 15px; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(228, 240, 245); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; white-space: pre-wrap; border-right-width: 0px !important; border-left-width: 5px !important;"><code style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">gen.throw(exception)</code></pre></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"></dd><dt style="margin: 0px; padding: 0px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">exception</code></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">用于抛出的异常。&nbsp;使用&nbsp;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Error" title="通过Error的构造器可以创建一个错误对象。当运行时错误产生时，Error的实例对象会被抛出。Error对象可用于用户自定义的异常的基础对象。下面列出了各种内建的标准错误类型。" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">Error</code></a>&nbsp;的实例对调试非常有帮助.</dd><dd style="color: rgb(102, 102, 102); margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><b>返回值</b></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><p style="margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">带有两个属性的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object" title="Object 构造函数创建一个对象包装器。" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">对象</code></a>：</p><ul style="list-style-position: initial; list-style-image: initial; margin-top: 0px; margin-bottom: 24px; padding: 0px 0px 0px 40px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><li style="margin: 0px 0px 6px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">done</code>&nbsp;(boolean)<ul style="list-style-position: initial; list-style-image: initial; padding: 6px 0px 0px 40px; border: 0px; box-sizing: border-box; max-width: 42rem;"><li style="margin: 0px 0px 6px; padding: 0px; border: 0px;">如果迭代器已经返回了迭代序列的末尾，则值为&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">true</code>。在这种情况下，<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">可以</code>指定迭代器&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">value&nbsp;</code>的返回值。&nbsp;</li><li style="margin: 0px 0px 6px; padding: 0px; border: 0px;">如果迭代能够继续生产在序列中的下一个值，则值为&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">false</code>。 这相当与不指定&nbsp;done 属性的值。</li></ul></li><li style="margin: 0px 0px 6px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">value</code>&nbsp;- 迭代器返回的任何 JavaScript 值。当 done 是 true 的时候可以省略。</li></ul></dd><dd style="color: rgb(102, 102, 102); margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><b>示例</b></dd><dd style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><h3 id="blogTitle25" name="Example:_Using_test" class="highlight-spanned" style="margin-top: 20px; margin-bottom: 20px; padding: 0px; border: 0px; font-size: 1.5rem; font-family: Palatino, &quot;Palatino Linotype&quot;, x-locale-heading-secondary, serif; line-height: 1.25; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); -webkit-box-decoration-break: clone;"><span class="highlight-span" style="margin: 0px; padding: 0px 4px 0px 40px; border: 0px; background-color: rgb(51, 51, 51); color: rgb(255, 255, 255); line-height: 1.25; -webkit-box-decoration-break: clone;">使用&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(255, 255, 255, 0.4) !important; border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(255, 255, 255) !important;">throw()</code></span></h3><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">下面的例子展示了一个简单的生成器并使用&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; font-family: courier, &quot;andale mono&quot;, monospace;">throw方法</span>向该生成器抛出一个异常，该异常通常可以通过&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;"><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/try...catch" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;">try...catch</a></code>&nbsp;块进行捕获.</p><pre class="brush: js line-numbers  language-js" style="margin-top: 0px; margin-bottom: 20px; padding: 15px 15px 15px 3.8em; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1.5; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; text-shadow: none; word-break: normal; word-wrap: normal; counter-reset: linenumber 0; border-right-width: 0px !important; border-left-width: 5px !important;"><code class=" language-js" style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; word-wrap: normal; text-shadow: none; direction: ltr; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; position: relative;">function* gen() {
  while(true) {
    try {
       yield 42;
    } catch(e) {
      console.log("Error caught!");
    }
  }
}

var g = gen();
g.next(); // { value: 42, done: false }
g.throw(new Error("Something went wrong")); // "Error caught!"</code></pre></dd></dl><h2 style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-bottom: 12px; font-family: &quot;Proxima Nova&quot;, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC Regular&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif; line-height: 1; word-wrap: break-word; padding: 0px; border: 0px;"><span style="font-weight: 700;">示例</span></h2><h3 style="color: rgb(102, 102, 102); font-weight: inherit; margin-top: 0px; margin-bottom: 12px; word-wrap: break-word; padding: 0px; border: 0px; line-height: 1;"><span style="font-weight: 700;">一个无限迭代器</span></h3><div><pre class="brush: js line-numbers  language-js" style="margin-bottom: 20px; padding: 15px 15px 15px 3.8em; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1.5; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; text-shadow: none; word-break: normal; word-wrap: normal; counter-reset: linenumber 0; border-right-width: 0px !important; border-left-width: 5px !important;"><code class=" language-js" style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; word-wrap: normal; text-shadow: none; direction: ltr; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; position: relative;">function* idMaker(){
    let index = 0;
    while(true)
        yield index++;
}

let gen = idMaker(); // "Generator { }"

console.log(gen.next().value); 
// 0
console.log(gen.next().value); 
// 1
console.log(gen.next().value); 
// 2
// ...</code></pre></div></div><h1 id="blogTitle28" style="font-family: &quot;Proxima Nova&quot;, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC Regular&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif;"><span style="margin: 0px; padding: 0px; border: 0px; position: relative; display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; font-weight: 700;"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/%E7%94%9F%E6%88%90%E5%99%A8%E5%87%BD%E6%95%B0" title="GeneratorFunction构造器生成新的generator function 对象。在JavaScript中，生成器函数实际上都是GeneratorFunction的实例对象" style="margin: 0px; padding: 0px; border: 0px; position: relative; display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis;">GeneratorFunction</a></span></h1></div><div><p style="margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><strong style="margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction</code>构造器</strong>生成新的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/function*" title="function*&nbsp;这种声明方式(function关键字后跟一个星号）会定义一个生成器函数 (generator function)，它返回一个 &nbsp;Generator&nbsp;&nbsp;对象。" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">生成器函数</code></a>&nbsp;对象。在JavaScript中，生成器函数实际上都是<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction</code>的实例对象。</p><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">注意，<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction</code>并不是一个全局对象。它可以通过下面的代码获取。</p><pre class="brush: js line-numbers  language-js" style="margin-top: 0px; margin-bottom: 20px; padding: 15px 15px 15px 3.8em; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1.5; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; text-shadow: none; word-break: normal; word-wrap: normal; counter-reset: linenumber 0; border-right-width: 0px !important; border-left-width: 5px !important;"><code class=" language-js" style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; word-wrap: normal; text-shadow: none; direction: ltr; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; position: relative;">Object.getPrototypeOf(function*(){}).constructor</code></pre></div><div><h2 id="blogTitle29" name="Syntax" style="margin-top: 103px; margin-bottom: 20px; padding: 0px; border: 0px; line-height: 1.2; position: relative;"><b>语法</b></h2><pre class="syntaxbox" style="margin-top: 0px; margin-bottom: 20px; padding: 15px; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(228, 240, 245); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; white-space: pre-wrap; border-right-width: 0px !important; border-left-width: 5px !important;"><code style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">new GeneratorFunction ([arg1[, arg2[, ...argN]],] functionBody)</code></pre><dl style="margin-top: 0px; margin-bottom: 20px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><dt style="margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">arg1, arg2, ... arg<span style="margin: 0px; padding: 0px; border: 0px;">N</span></code></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;">函数使用的名称作为形式参数名称。每个必须是一个字符串，对应于一个有效的JavaScript标识符或这样的字符串的列表，用逗号分隔；如“<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">x</code>”，“<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">theValue</code>”或“<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">a,b</code>”。</dd><dt style="margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">functionBody</code></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;">一个包含多条表示JavaScript函数体语句的字符串。</dd></dl></div><div><h2 id="blogTitle30" name="Description" style="margin-top: 103px; margin-bottom: 20px; padding: 0px; border: 0px; line-height: 1.2; position: relative;"><b>描述</b></h2><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">当创建函数时，将使用<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction</code>构造函数创建的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/function*" title="function*&nbsp;这种声明方式(function关键字后跟一个星号）会定义一个生成器函数 (generator function)，它返回一个 &nbsp;Generator&nbsp;&nbsp;对象。" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">生成器函数</code></a>对象进行解析。这比使用<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/function*" title="function*&nbsp;这种声明方式(function关键字后跟一个星号）会定义一个生成器函数 (generator function)，它返回一个 &nbsp;Generator&nbsp;&nbsp;对象。" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">function* 表达式</code></a>&nbsp;声明生成器函数效率更低，并且在代码中调用它，因为这些函数与其余的代码一起被解析。</p><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">传递给函数的所有参数按照它们被传递的顺序被视为要创建的函数中参数的标识符的名称。</p><div class="note" style="margin: 0px 0px 20px; padding: 10px 10px 10px 30px; border-width: 0px 0px 0px 5px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-color: rgb(246, 183, 60); border-image: initial; box-sizing: border-box; max-width: 42rem; overflow: hidden; clear: none; background: rgb(255, 243, 212); font-family: x-locale-heading-primary, zillaslab, Palatino, &quot;Palatino Linotype&quot;, x-locale-heading-secondary, serif; font-size: 1.125rem; color: rgb(51, 51, 51);"><p style="margin-bottom: 0px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem;"><span style="margin: 0px; padding: 0px; border: 0px; font-weight: 700;">提示：</span>使用<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; font-size: 1rem;">GeneratorFunction</code>构造函数创建的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/function*" title="function*&nbsp;这种声明方式(function关键字后跟一个星号）会定义一个生成器函数 (generator function)，它返回一个 &nbsp;Generator&nbsp;&nbsp;对象。" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; font-size: 1rem;">生成器函数</code></a>不会为其创建上下文创建闭包；它们始终在全局范围内创建。当运行它们时，它们只能访问自己的本地变量和全局变量，而不是从<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; font-size: 1rem;">GeneratorFunction</code>构造函数调用的范围的变量。这与使用<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/eval" title="执行指定代码之后的返回值。如果返回值为空，返回undefined" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; font-size: 1rem;">eval</code></a>与生成函数表达式的代码不同。</p></div><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">将<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction</code>构造函数调用为函数（不使用<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">new</code>运算符）与将其作为构造函数调用的效果相同。</p><h2 id="blogTitle31" name="Properties" style="margin-top: 103px; margin-bottom: 20px; padding: 0px; border: 0px; line-height: 1.2; position: relative;"><b>静态属性</b></h2><dl style="margin-top: 0px; margin-bottom: 20px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><dt style="margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;"><strong style="margin: 0px; padding: 0px; border: 0px;">GeneratorFunction.length</strong></code></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction</code>构造函数的 length 属性值为 1。</dd><dt style="margin: 0px; padding: 0px; border: 0px;"><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/GeneratorFunction/prototype" title="GeneratorFunction.prototype属性是GeneratorFunction的原型对象。" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction.prototype</code></a></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;">允许向所有生成器函数对象添加属性。</dd></dl><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><br></p><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><br></p><p style="margin-top: 0px; margin-bottom: 24px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><br></p></div><h1 id="blogTitle32"><b>GeneratorFunction 对象原型</b></h1><div><code style="margin: 0px; padding: 0px 2px; border: 0px; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(51, 51, 51); font-size: medium; white-space: normal;">GeneratorFunction</code><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">实例从</span><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/GeneratorFunction/prototype" title="GeneratorFunction.prototype属性是GeneratorFunction的原型对象。" style="color: rgb(63, 135, 166); margin: 0px; padding: 0px; border: 0px; font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction.prototype</code></a><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">继承方法和属性。与所有构造函数一样，你可以更改构造函数的原型对象以对所有</span><code style="margin: 0px; padding: 0px 2px; border: 0px; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word; color: rgb(51, 51, 51); font-size: medium; white-space: normal;">GeneratorFunction</code><span style="color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);">实例进行更改。</span><b><br></b></div><div><h2 style="margin-top: 20px; margin-bottom: 20px; padding: 0px; border: 0px; line-height: 1.25; -webkit-box-decoration-break: clone;" id="blogTitle33"><span class="highlight-span" style="margin: 0px; padding: 0px 4px 0px 40px; border: 0px; line-height: 1.25; -webkit-box-decoration-break: clone;"><b>属性</b></span></h2><div style="margin: 0px; padding: 0px; border: 0px; color: rgb(51, 51, 51); font-family: &quot;Open Sans&quot;, arial, x-locale-body, sans-serif; font-size: medium; background-color: rgb(255, 255, 255);"><dl style="margin-bottom: 20px; padding: 0px; border: 0px; box-sizing: border-box; max-width: 42rem;"><dt style="margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;"><strong style="margin: 0px; padding: 0px; border: 0px;">GeneratorFunction.constructor</strong></code></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;">初始值是&nbsp;<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/GeneratorFunction" title="此页面仍未被本地化, 期待您的翻译!" class="new" rel="nofollow" style="color: rgb(153, 0, 0); margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">GeneratorFunction</code></a>.</dd><dt style="margin: 0px; padding: 0px; border: 0px;"><code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;"><strong style="margin: 0px; padding: 0px; border: 0px;">GeneratorFunction.prototype.prototype</strong></code></dt><dd style="margin-top: 0px; margin-right: 0px; margin-bottom: 24px; padding: 0px 0px 0px 20px; border: 0px;">值是&nbsp;<code style="font-style: inherit; margin: 0px; padding: 0px 2px; border: 0px; font-weight: inherit; background-color: rgba(220, 220, 220, 0.5); border-radius: 2px; font-family: consolas, &quot;Liberation Mono&quot;, courier, monospace; word-wrap: break-word;">%GeneratorPrototype%</code>.</dd></dl></div></div><div><h2 id="blogTitle34" name="Examples" style="margin-top: 103px; margin-bottom: 20px; padding: 0px; border: 0px; line-height: 1.2; position: relative;"><b>示例</b></h2><h3 id="blogTitle35" class="highlight-spanned" style="margin-top: 20px; margin-bottom: 20px; padding: 0px; border: 0px; line-height: 1.25; -webkit-box-decoration-break: clone;"><span class="highlight-span" style="margin: 0px; padding: 0px 4px 0px 40px; border: 0px; line-height: 1.25; -webkit-box-decoration-break: clone;"><b>从<span style="padding-right: 2px; padding-left: 2px; border-style: initial; border-color: initial; border-image: initial; border-radius: 2px;">GeneratorFunction</span>构造函数创建一个生成器函数</b></span></h3><pre class="brush: js line-numbers  language-js" style="margin-top: 0px; margin-bottom: 20px; padding: 15px 15px 15px 3.8em; border-top: 0px solid rgb(63, 135, 166); border-bottom: 0px solid rgb(63, 135, 166); border-right-style: solid; border-left-style: solid; border-right-color: rgb(63, 135, 166); border-left-color: rgb(63, 135, 166); border-image: initial; box-sizing: border-box; position: relative; font-size: medium; background-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: consolas, monaco, &quot;Andale Mono&quot;, monospace; line-height: 1.5; direction: ltr; hyphens: none; width: 625.172px; max-width: 100%; text-shadow: none; word-break: normal; word-wrap: normal; counter-reset: linenumber 0; border-right-width: 0px !important; border-left-width: 5px !important;"><code class=" language-js" style="margin: 0px; padding: 0px; border: 0px; font-weight: inherit; background-color: transparent; border-radius: 2px; font-family: Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace; word-wrap: normal; text-shadow: none; direction: ltr; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; position: relative;">var GeneratorFunction = Object.getPrototypeOf(function*(){}).constructor
var g = new GeneratorFunction("a", "yield a * 2");
var iterator = g(10);
console.log(iterator.next().value); // 20</code></pre></div><div><h1 id="blogTitle36" style="font-size: 2em; margin-top: 0.67em; margin-bottom: 0.67em; color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator 函数的异步应用</h1><ol class="content-toc" id="content-toc" style="padding-top: 0.5rem; padding-bottom: 0.5rem; background: rgb(189, 195, 199); border-radius: 5px; color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><li data-src="传统方法" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/generator-async#传统方法" style="background-position: initial; color: rgb(70, 130, 190);">传统方法</a></li><li data-src="基本概念" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/generator-async#基本概念" style="background-position: initial; color: rgb(70, 130, 190);">基本概念</a></li><li data-src="Generator-函数" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/generator-async#Generator 函数" style="background-position: initial; color: rgb(70, 130, 190);">Generator 函数</a></li><li data-src="Thunk-函数" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/generator-async#Thunk 函数" style="background-position: initial; color: rgb(70, 130, 190);">Thunk 函数</a></li><li data-src="co-模块" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/generator-async#co 模块" style="background-position: initial; color: rgb(70, 130, 190);">co 模块</a></li></ol><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">异步编程对 JavaScript 语言太重要。Javascript 语言的执行环境是“单线程”的，如果没有异步编程，根本没法用，非卡死不可。本章主要介绍 Generator 函数如何完成异步操作。</p><h2 id="blogTitle37" class="传统方法" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">传统方法</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">ES6 诞生以前，异步编程的方法，大概有下面四种。</p><ul style="list-style-type: none; padding-top: 0.5rem; padding-bottom: 0.5rem; color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><li style="text-indent: -5px; font-size: 0.8rem;">回调函数</li><li style="text-indent: -5px; font-size: 0.8rem;">事件监听</li><li style="text-indent: -5px; font-size: 0.8rem;">发布/订阅</li><li style="text-indent: -5px; font-size: 0.8rem;">Promise 对象</li></ul><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数将 JavaScript 异步编程带入了一个全新的阶段。</p><h2 id="blogTitle38" class="基本概念" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">基本概念</h2><h3 id="blogTitle39" class="异步" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">异步</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">所谓"异步"，简单说就是一个任务不是连续完成的，可以理解成该任务被人为分成两段，先执行第一段，然后转而执行其他任务，等做好了准备，再回过头执行第二段。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">比如，有一个任务是读取文件进行处理，任务的第一段是向操作系统发出请求，要求读取文件。然后，程序执行其他任务，等到操作系统返回文件，再接着执行任务的第二段（处理文件）。这种不连续的执行，就叫做异步。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">相应地，连续的执行就叫做同步。由于是连续执行，不能插入其他任务，所以操作系统从硬盘读取文件的这段时间，程序只能干等着。</p><h3 id="blogTitle40" class="回调函数" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">回调函数</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">JavaScript 语言对异步编程的实现，就是回调函数。所谓回调函数，就是把任务的第二段单独写在一个函数里面，等到重新执行这个任务的时候，就直接调用这个函数。回调函数的英语名字<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">callback</code>，直译过来就是"重新调用"。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">读取文件进行处理，是这样写的。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">fs.readFile('/etc/passwd', 'utf-8', function (err, data) {
  if (err) throw err;
  console.log(data);
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">readFile</code>函数的第三个参数，就是回调函数，也就是任务的第二段。等到操作系统返回了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">/etc/passwd</code>这个文件以后，回调函数才会执行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">一个有趣的问题是，为什么 Node 约定，回调函数的第一个参数，必须是错误对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">err</code>（如果没有错误，该参数就是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">null</code>）？</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">原因是执行分成两段，第一段执行完以后，任务所在的上下文环境就已经结束了。在这以后抛出的错误，原来的上下文环境已经无法捕捉，只能当作参数，传入第二段。</p><h3 id="blogTitle41" class="Promise" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Promise</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">回调函数本身并没有问题，它的问题出现在多个回调函数嵌套。假定读取<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">A</code>文件之后，再读取<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">B</code>文件，代码如下。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">fs.readFile(fileA, 'utf-8', function (err, data) {
  fs.readFile(fileB, 'utf-8', function (err, data) {
    // ...
  });
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">不难想象，如果依次读取两个以上的文件，就会出现多重嵌套。代码不是纵向发展，而是横向发展，很快就会乱成一团，无法管理。因为多个异步操作形成了强耦合，只要有一个操作需要修改，它的上层回调函数和下层回调函数，可能都要跟着修改。这种情况就称为"回调函数地狱"（callback hell）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Promise 对象就是为了解决这个问题而提出的。它不是新的语法功能，而是一种新的写法，允许将回调函数的嵌套，改成链式调用。采用 Promise，连续读取多个文件，写法如下。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var readFile = require('fs-readfile-promise');

readFile(fileA)
.then(function (data) {
  console.log(data.toString());
})
.then(function () {
  return readFile(fileB);
})
.then(function (data) {
  console.log(data.toString());
})
.catch(function (err) {
  console.log(err);
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，我使用了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">fs-readfile-promise</code>模块，它的作用就是返回一个 Promise 版本的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">readFile</code>函数。Promise 提供<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法加载回调函数，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>方法捕捉执行过程中抛出的错误。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">可以看到，Promise 的写法只是回调函数的改进，使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法以后，异步任务的两段执行看得更清楚了，除此以外，并无新意。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Promise 的最大问题是代码冗余，原来的任务被 Promise 包装了一下，不管什么操作，一眼看去都是一堆<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>，原来的语义变得很不清楚。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">那么，有没有更好的写法呢？</p><h2 id="blogTitle42" class="Generator-函数" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator 函数</h2><h3 id="blogTitle43" class="协程" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">协程</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">传统的编程语言，早有异步编程的解决方案（其实是多任务的解决方案）。其中有一种叫做"协程"（coroutine），意思是多个线程互相协作，完成异步任务。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">协程有点像函数，又有点像线程。它的运行流程大致如下。</p><ul style="list-style-type: none; padding-top: 0.5rem; padding-bottom: 0.5rem; color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><li style="text-indent: -5px; font-size: 0.8rem;">第一步，协程<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">A</code>开始执行。</li><li style="text-indent: -5px; font-size: 0.8rem;">第二步，协程<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">A</code>执行到一半，进入暂停，执行权转移到协程<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">B</code>。</li><li style="text-indent: -5px; font-size: 0.8rem;">第三步，（一段时间后）协程<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">B</code>交还执行权。</li><li style="text-indent: -5px; font-size: 0.8rem;">第四步，协程<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">A</code>恢复执行。</li></ul><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面流程的协程<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">A</code>，就是异步任务，因为它分成两段（或多段）执行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">举例来说，读取文件的协程写法如下。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* asyncJob() {
  // ...其他代码
  var f = yield readFile(fileA);
  // ...其他代码
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码的函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">asyncJob</code>是一个协程，它的奥妙就在其中的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令。它表示执行到此处，执行权将交给其他协程。也就是说，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令是异步两个阶段的分界线。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">协程遇到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令就暂停，等到执行权返回，再从暂停的地方继续往后执行。它的最大优点，就是代码的写法非常像同步操作，如果去除<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令，简直一模一样。</p><h3 id="blogTitle44" class="协程的-Generator-函数实现" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">协程的 Generator 函数实现</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数是协程在 ES6 的实现，最大特点就是可以交出函数的执行权（即暂停执行）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">整个 Generator 函数就是一个封装的异步任务，或者说是异步任务的容器。异步操作需要暂停的地方，都用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>语句注明。Generator 函数的执行方法如下。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen(x) {
  var y = yield x + 2;
  return y;
}

var g = gen(1);
g.next() // { value: 3, done: false }
g.next() // { value: undefined, done: true }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，调用 Generator 函数，会返回一个内部指针（即遍历器）<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>。这是 Generator 函数不同于普通函数的另一个地方，即执行它不会返回结果，返回的是指针对象。调用指针<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，会移动内部指针（即执行异步任务的第一段），指向第一个遇到的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>语句，上例是执行到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x + 2</code>为止。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">换言之，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的作用是分阶段执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Generator</code>函数。每次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，会返回一个对象，表示当前阶段的信息（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性）。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>语句后面表达式的值，表示当前阶段的值；<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性是一个布尔值，表示 Generator 函数是否执行完毕，即是否还有下一个阶段。</p><h3 id="blogTitle45" class="Generator-函数的数据交换和错误处理" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator 函数的数据交换和错误处理</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数可以暂停执行和恢复执行，这是它能封装异步任务的根本原因。除此之外，它还有两个特性，使它可以作为异步编程的完整解决方案：函数体内外的数据交换和错误处理机制。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>返回值的 value 属性，是 Generator 函数向外输出数据；<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法还可以接受参数，向 Generator 函数体内输入数据。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen(x){
  var y = yield x + 2;
  return y;
}

var g = gen(1);
g.next() // { value: 3, done: false }
g.next(2) // { value: 2, done: true }</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，第一<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性，返回表达式<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x + 2</code>的值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">3</code>。第二个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法带有参数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">2</code>，这个参数可以传入 Generator 函数，作为上个阶段异步任务的返回结果，被函数体内的变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">y</code>接收。因此，这一步的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性，返回的就是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">2</code>（变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">y</code>的值）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数内部还可以部署错误处理代码，捕获函数体外抛出的错误。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen(x){
  try {
    var y = yield x + 2;
  } catch (e){
    console.log(e);
  }
  return y;
}

var g = gen(1);
g.next();
g.throw('出错了');
// 出错了</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码的最后一行，Generator 函数体外，使用指针对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">throw</code>方法抛出的错误，可以被函数体内的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块捕获。这意味着，出错的代码与处理错误的代码，实现了时间和空间上的分离，这对于异步编程无疑是很重要的。</p><h3 id="blogTitle46" class="异步任务的封装" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">异步任务的封装</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面看看如何使用 Generator 函数，执行一个真实的异步任务。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var fetch = require('node-fetch');

function* gen(){
  var url = 'https://api.github.com/users/github';
  var result = yield fetch(url);
  console.log(result.bio);
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，Generator 函数封装了一个异步操作，该操作先读取一个远程接口，然后从 JSON 格式的数据解析信息。就像前面说过的，这段代码非常像同步操作，除了加上了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">执行这段代码的方法如下。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var g = gen();
var result = g.next();

result.value.then(function(data){
  return data.json();
}).then(function(data){
  g.next(data);
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，首先执行 Generator 函数，获取遍历器对象，然后使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法（第二行），执行异步任务的第一阶段。由于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Fetch</code>模块返回的是一个 Promise 对象，因此要用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法调用下一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">可以看到，虽然 Generator 函数将异步操作表示得很简洁，但是流程管理却不方便（即何时执行第一阶段、何时执行第二阶段）。</p><h2 id="blogTitle47" class="Thunk-函数" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">Thunk 函数</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Thunk 函数是自动执行 Generator 函数的一种方法。</p><h3 id="blogTitle48" class="参数的求值策略" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">参数的求值策略</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Thunk 函数早在上个世纪 60 年代就诞生了。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">那时，编程语言刚刚起步，计算机学家还在研究，编译器怎么写比较好。一个争论的焦点是"求值策略"，即函数的参数到底应该何时求值。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var x = 1;

function f(m){
  return m * 2;
}

f(x + 5)</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码先定义函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>，然后向它传入表达式<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x + 5</code>。请问，这个表达式应该何时求值？</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">一种意见是"传值调用"（call by value），即在进入函数体之前，就计算<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x + 5</code>的值（等于 6），再将这个值传入函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>。C 语言就采用这种策略。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">f(x + 5)
// 传值调用时，等同于
f(6)</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">另一种意见是“传名调用”（call by name），即直接将表达式<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x + 5</code>传入函数体，只在用到它的时候求值。Haskell 语言采用这种策略。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">f(x + 5)
// 传名调用时，等同于
(x + 5) * 2</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">传值调用和传名调用，哪一种比较好？</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">回答是各有利弊。传值调用比较简单，但是对参数求值的时候，实际上还没用到这个参数，有可能造成性能损失。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function f(a, b){
  return b;
}

f(3 * x * x - 2 * x - 1, x);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>的第一个参数是一个复杂的表达式，但是函数体内根本没用到。对这个参数求值，实际上是不必要的。因此，有一些计算机学家倾向于"传名调用"，即只在执行时求值。</p><h3 id="blogTitle49" class="Thunk-函数的含义" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Thunk 函数的含义</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">编译器的“传名调用”实现，往往是将参数放到一个临时函数之中，再将这个临时函数传入函数体。这个临时函数就叫做 Thunk 函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function f(m) {
  return m * 2;
}

f(x + 5);

// 等同于

var thunk = function () {
  return x + 5;
};

function f(thunk) {
  return thunk() * 2;
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，函数 f 的参数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x + 5</code>被一个函数替换了。凡是用到原参数的地方，对<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Thunk</code>函数求值即可。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这就是 Thunk 函数的定义，它是“传名调用”的一种实现策略，用来替换某个表达式。</p><h3 id="blogTitle50" class="JavaScript-语言的-Thunk-函数" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">JavaScript 语言的 Thunk 函数</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">JavaScript 语言是传值调用，它的 Thunk 函数含义有所不同。在 JavaScript 语言中，Thunk 函数替换的不是表达式，而是多参数函数，将其替换成一个只接受回调函数作为参数的单参数函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">// 正常版本的readFile（多参数版本）
fs.readFile(fileName, callback);

// Thunk版本的readFile（单参数版本）
var Thunk = function (fileName) {
  return function (callback) {
    return fs.readFile(fileName, callback);
  };
};

var readFileThunk = Thunk(fileName);
readFileThunk(callback);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">fs</code>模块的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">readFile</code>方法是一个多参数函数，两个参数分别为文件名和回调函数。经过转换器处理，它变成了一个单参数函数，只接受回调函数作为参数。这个单参数版本，就叫做 Thunk 函数。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">任何函数，只要参数有回调函数，就能写成 Thunk 函数的形式。下面是一个简单的 Thunk 函数转换器。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">// ES5版本
var Thunk = function(fn){
  return function (){
    var args = Array.prototype.slice.call(arguments);
    return function (callback){
      args.push(callback);
      return fn.apply(this, args);
    }
  };
};

// ES6版本
const Thunk = function(fn) {
  return function (...args) {
    return function (callback) {
      return fn.call(this, ...args, callback);
    }
  };
};</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">使用上面的转换器，生成<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">fs.readFile</code>的 Thunk 函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var readFileThunk = Thunk(fs.readFile);
readFileThunk(fileA)(callback);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是另一个完整的例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function f(a, cb) {
  cb(a);
}
const ft = Thunk(f);

ft(1)(console.log) // 1</code></pre><h3 id="blogTitle51" class="Thunkify-模块" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Thunkify 模块</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">生产环境的转换器，建议使用 Thunkify 模块。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">首先是安装。</p><pre class=" language-bash" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-bash" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">$ npm install thunkify</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">使用方式如下。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var thunkify = require('thunkify');
var fs = require('fs');

var read = thunkify(fs.readFile);
read('package.json')(function(err, str){
  // ...
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Thunkify 的源码与上一节那个简单的转换器非常像。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function thunkify(fn) {
  return function() {
    var args = new Array(arguments.length);
    var ctx = this;

    for (var i = 0; i &lt; args.length; ++i) {
      args[i] = arguments[i];
    }

    return function (done) {
      var called;

      args.push(function () {
        if (called) return;
        called = true;
        done.apply(null, arguments);
      });

      try {
        fn.apply(ctx, args);
      } catch (err) {
        done(err);
      }
    }
  }
};</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">它的源码主要多了一个检查机制，变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">called</code>确保回调函数只运行一次。这样的设计与下文的 Generator 函数相关。请看下面的例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function f(a, b, callback){
  var sum = a + b;
  callback(sum);
  callback(sum);
}

var ft = thunkify(f);
var print = console.log.bind(console);
ft(1, 2)(print);
// 3</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，由于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">thunkify</code>只允许回调函数执行一次，所以只输出一行结果。</p><h3 id="blogTitle52" class="Generator-函数的流程管理" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Generator 函数的流程管理</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">你可能会问， Thunk 函数有什么用？回答是以前确实没什么用，但是 ES6 有了 Generator 函数，Thunk 函数现在可以用于 Generator 函数的自动流程管理。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数可以自动执行。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function* gen() {
  // ...
}

var g = gen();
var res = g.next();

while(!res.done){
  console.log(res.value);
  res = g.next();
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，Generator 函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen</code>会自动执行完所有步骤。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">但是，这不适合异步操作。如果必须保证前一步执行完，才能执行后一步，上面的自动执行就不可行。这时，Thunk 函数就能派上用处。以读取文件为例。下面的 Generator 函数封装了两个异步操作。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var fs = require('fs');
var thunkify = require('thunkify');
var readFileThunk = thunkify(fs.readFile);

var gen = function* (){
  var r1 = yield readFileThunk('/etc/fstab');
  console.log(r1.toString());
  var r2 = yield readFileThunk('/etc/shells');
  console.log(r2.toString());
};</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令用于将程序的执行权移出 Generator 函数，那么就需要一种方法，将执行权再交还给 Generator 函数。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这种方法就是 Thunk 函数，因为它可以在回调函数里，将执行权交还给 Generator 函数。为了便于理解，我们先看如何手动执行上面这个 Generator 函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var g = gen();

var r1 = g.next();
r1.value(function (err, data) {
  if (err) throw err;
  var r2 = g.next(data);
  r2.value(function (err, data) {
    if (err) throw err;
    g.next(data);
  });
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>是 Generator 函数的内部指针，表示目前执行到哪一步。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法负责将指针移动到下一步，并返回该步的信息（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">仔细查看上面的代码，可以发现 Generator 函数的执行过程，其实是将同一个回调函数，反复传入<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性。这使得我们可以用递归来自动完成这个过程。</p><h3 id="blogTitle53" class="Thunk-函数的自动流程管理" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Thunk 函数的自动流程管理</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Thunk 函数真正的威力，在于可以自动执行 Generator 函数。下面就是一个基于 Thunk 函数的 Generator 执行器。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function run(fn) {
  var gen = fn();

  function next(err, data) {
    var result = gen.next(data);
    if (result.done) return;
    result.value(next);
  }

  next();
}

function* g() {
  // ...
}

run(g);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">run</code>函数，就是一个 Generator 函数的自动执行器。内部的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>函数就是 Thunk 的回调函数。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>函数先将指针移到 Generator 函数的下一步（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen.next</code>方法），然后判断 Generator 函数是否结束（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">result.done</code>属性），如果没结束，就将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>函数再传入 Thunk 函数（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">result.value</code>属性），否则就直接退出。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">有了这个执行器，执行 Generator 函数方便多了。不管内部有多少个异步操作，直接把 Generator 函数传入<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">run</code>函数即可。当然，前提是每一个异步操作，都要是 Thunk 函数，也就是说，跟在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令后面的必须是 Thunk 函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var g = function* (){
  var f1 = yield readFileThunk('fileA');
  var f2 = yield readFileThunk('fileB');
  // ...
  var fn = yield readFileThunk('fileN');
};

run(g);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">g</code>封装了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">n</code>个异步的读取文件操作，只要执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">run</code>函数，这些操作就会自动完成。这样一来，异步操作不仅可以写得像同步操作，而且一行代码就可以执行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Thunk 函数并不是 Generator 函数自动执行的唯一方案。因为自动执行的关键是，必须有一种机制，自动控制 Generator 函数的流程，接收和交还程序的执行权。回调函数可以做到这一点，Promise 对象也可以做到这一点。</p><h2 id="blogTitle54" class="co-模块" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">co 模块</h2><h3 id="blogTitle55" class="基本用法" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">基本用法</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><a href="https://github.com/tj/co" style="background-position: initial; color: rgb(70, 130, 190);">co 模块</a>是著名程序员 TJ Holowaychuk 于 2013 年 6 月发布的一个小工具，用于 Generator 函数的自动执行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是一个 Generator 函数，用于依次读取两个文件。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var gen = function* () {
  var f1 = yield readFile('/etc/fstab');
  var f2 = yield readFile('/etc/shells');
  console.log(f1.toString());
  console.log(f2.toString());
};</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">co 模块可以让你不用编写 Generator 函数的执行器。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var co = require('co');
co(gen);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，Generator 函数只要传入<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">co</code>函数，就会自动执行。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">co</code>函数返回一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Promise</code>对象，因此可以用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法添加回调函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">co(gen).then(function (){
  console.log('Generator 函数执行完成');
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，等到 Generator 函数执行结束，就会输出一行提示。</p><h3 id="blogTitle56" class="co-模块的原理" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">co 模块的原理</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">为什么 co 可以自动执行 Generator 函数？</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">前面说过，Generator 就是一个异步操作的容器。它的自动执行需要一种机制，当异步操作有了结果，能够自动交回执行权。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">两种方法可以做到这一点。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（1）回调函数。将异步操作包装成 Thunk 函数，在回调函数里面交回执行权。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（2）Promise 对象。将异步操作包装成 Promise 对象，用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法交回执行权。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">co 模块其实就是将两种自动执行器（Thunk 函数和 Promise 对象），包装成一个模块。使用 co 的前提条件是，Generator 函数的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令后面，只能是 Thunk 函数或 Promise 对象。如果数组或对象的成员，全部都是 Promise 对象，也可以使用 co，详见后文的例子。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上一节已经介绍了基于 Thunk 函数的自动执行器。下面来看，基于 Promise 对象的自动执行器。这是理解 co 模块必须的。</p><h3 id="blogTitle57" class="基于-Promise-对象的自动执行" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">基于 Promise 对象的自动执行</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">还是沿用上面的例子。首先，把<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">fs</code>模块的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">readFile</code>方法包装成一个 Promise 对象。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var fs = require('fs');

var readFile = function (fileName){
  return new Promise(function (resolve, reject){
    fs.readFile(fileName, function(error, data){
      if (error) return reject(error);
      resolve(data);
    });
  });
};

var gen = function* (){
  var f1 = yield readFile('/etc/fstab');
  var f2 = yield readFile('/etc/shells');
  console.log(f1.toString());
  console.log(f2.toString());
};</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">然后，手动执行上面的 Generator 函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">var g = gen();

g.next().value.then(function(data){
  g.next(data).value.then(function(data){
    g.next(data);
  });
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">手动执行其实就是用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法，层层添加回调函数。理解了这一点，就可以写出一个自动执行器。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function run(gen){
  var g = gen();

  function next(data){
    var result = g.next(data);
    if (result.done) return result.value;
    result.value.then(function(data){
      next(data);
    });
  }

  next();
}

run(gen);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，只要 Generator 函数还没执行到最后一步，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>函数就调用自身，以此实现自动执行。</p><h3 id="blogTitle58" class="co-模块的源码" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">co 模块的源码</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">co 就是上面那个自动执行器的扩展，它的源码只有几十行，非常简单。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">首先，co 函数接受 Generator 函数作为参数，返回一个 Promise 对象。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function co(gen) {
  var ctx = this;

  return new Promise(function(resolve, reject) {
  });
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">在返回的 Promise 对象里面，co 先检查参数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen</code>是否为 Generator 函数。如果是，就执行该函数，得到一个内部指针对象；如果不是就返回，并将 Promise 对象的状态改为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">resolved</code>。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function co(gen) {
  var ctx = this;

  return new Promise(function(resolve, reject) {
    if (typeof gen === 'function') gen = gen.call(ctx);
    if (!gen || typeof gen.next !== 'function') return resolve(gen);
  });
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">接着，co 将 Generator 函数的内部指针对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，包装成<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">onFulfilled</code>函数。这主要是为了能够捕捉抛出的错误。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function co(gen) {
  var ctx = this;

  return new Promise(function(resolve, reject) {
    if (typeof gen === 'function') gen = gen.call(ctx);
    if (!gen || typeof gen.next !== 'function') return resolve(gen);

    onFulfilled();
    function onFulfilled(res) {
      var ret;
      try {
        ret = gen.next(res);
      } catch (e) {
        return reject(e);
      }
      next(ret);
    }
  });
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">最后，就是关键的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>函数，它会反复调用自身。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">function next(ret) {
  if (ret.done) return resolve(ret.value);
  var value = toPromise.call(ctx, ret.value);
  if (value &amp;&amp; isPromise(value)) return value.then(onFulfilled, onRejected);
  return onRejected(
    new TypeError(
      'You may only yield a function, promise, generator, array, or object, '
      + 'but the following object was passed: "'
      + String(ret.value)
      + '"'
    )
  );
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>函数的内部代码，一共只有四行命令。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第一行，检查当前是否为 Generator 函数的最后一步，如果是就返回。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第二行，确保每一步的返回值，是 Promise 对象。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第三行，使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法，为返回值加上回调函数，然后通过<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">onFulfilled</code>函数再次调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>函数。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第四行，在参数不符合要求的情况下（参数非 Thunk 函数和 Promise 对象），将 Promise 对象的状态改为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">rejected</code>，从而终止执行。</p><h3 id="blogTitle59" class="处理并发的异步操作" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">处理并发的异步操作</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">co 支持并发的异步操作，即允许某些操作同时进行，等到它们全部完成，才进行下一步。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这时，要把并发的操作都放在数组或对象里面，跟在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>语句后面。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">// 数组的写法
co(function* () {
  var res = yield [
    Promise.resolve(1),
    Promise.resolve(2)
  ];
  console.log(res);
}).catch(onerror);

// 对象的写法
co(function* () {
  var res = yield {
    1: Promise.resolve(1),
    2: Promise.resolve(2),
  };
  console.log(res);
}).catch(onerror);</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是另一个例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">co(function* () {
  var values = [n1, n2, n3];
  yield values.map(somethingAsync);
});

function* somethingAsync(x) {
  // do something async
  return y
}</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面的代码允许并发三个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">somethingAsync</code>异步操作，等到它们全部完成，才会进行下一步。</p><h3 id="blogTitle60" class="实例：处理-Stream" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">实例：处理 Stream</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Node 提供 Stream 模式读写数据，特点是一次只处理数据的一部分，数据分成一块块依次处理，就好像“数据流”一样。这对于处理大规模数据非常有利。Stream 模式使用 EventEmitter API，会释放三个事件。</p><ul style="list-style-type: none; padding-top: 0.5rem; padding-bottom: 0.5rem; color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><li style="text-indent: -5px; font-size: 0.8rem;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">data</code>事件：下一块数据块已经准备好了。</li><li style="text-indent: -5px; font-size: 0.8rem;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">end</code>事件：整个“数据流”处理“完了。</li><li style="text-indent: -5px; font-size: 0.8rem;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">error</code>事件：发生错误。</li></ul><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Promise.race()</code>函数，可以判断这三个事件之中哪一个最先发生，只有当<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">data</code>事件最先发生时，才进入下一个数据块的处理。从而，我们可以通过一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">while</code>循环，完成所有数据的读取。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const co = require('co');
const fs = require('fs');

const stream = fs.createReadStream('./les_miserables.txt');
let valjeanCount = 0;

co(function*() {
  while(true) {
    const res = yield Promise.race([
      new Promise(resolve =&gt; stream.once('data', resolve)),
      new Promise(resolve =&gt; stream.once('end', resolve)),
      new Promise((resolve, reject) =&gt; stream.once('error', reject))
    ]);
    if (!res) {
      break;
    }
    stream.removeAllListeners('data');
    stream.removeAllListeners('end');
    stream.removeAllListeners('error');
    valjeanCount += (res.toString().match(/valjean/ig) || []).length;
  }
  console.log('count:', valjeanCount); // count: 1120
});</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码采用 Stream 模式读取《悲惨世界》的文本文件，对于每个数据块都使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">stream.once</code>方法，在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">data</code>、<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">end</code>、<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">error</code>三个事件上添加一次性回调函数。变量<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">res</code>只有在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">data</code>事件发生时才有值，然后累加每个数据块之中<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">valjean</code>这个词出现的次数。</p></div><div><h1 id="async-" style="font-size: 2em; margin-top: 0.67em; margin-bottom: 0.67em; color: rgb(51, 51, 51); font-family: Verdana, Arial;">async 函数</h1><ol class="content-toc" id="content-toc" style="padding-top: 0.5rem; padding-bottom: 0.5rem; background: rgb(189, 195, 199); border-radius: 5px; color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><li data-src="含义" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/async#含义" style="background-position: initial; color: rgb(70, 130, 190);">含义</a></li><li data-src="基本用法" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/async#基本用法" style="background-position: initial; color: rgb(70, 130, 190);">基本用法</a></li><li data-src="语法" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/async#语法" style="background-position: initial; color: rgb(70, 130, 190);">语法</a></li><li data-src="async-函数的实现原理" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/async#async 函数的实现原理" style="background-position: initial; color: rgb(70, 130, 190);">async 函数的实现原理</a></li><li data-src="与其他异步处理方法的比较" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/async#与其他异步处理方法的比较" style="background-position: initial; color: rgb(70, 130, 190);">与其他异步处理方法的比较</a></li><li data-src="实例：按顺序完成异步操作" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/async#实例：按顺序完成异步操作" style="background-position: initial; color: rgb(70, 130, 190);">实例：按顺序完成异步操作</a></li><li data-src="异步遍历器" class="link" style="text-indent: -5px; font-size: 0.7rem; color: rgb(41, 128, 185); font-weight: bold; cursor: pointer;"><a href="http://es6.ruanyifeng.com/#docs/async#异步遍历器" style="background-position: initial; color: rgb(70, 130, 190);">异步遍历器</a></li></ol><h2 id="含义" class="含义" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">含义</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">ES2017 标准引入了 async 函数，使得异步操作变得更加方便。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">async 函数是什么？一句话，它就是 Generator 函数的语法糖。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">前文有一个 Generator 函数，依次读取两个文件。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const fs <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">require<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'fs'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

const readFile <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>fileName<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Promise</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> reject<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    fs<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">readFile<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>fileName<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>error<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> data<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      <span class="token keyword" style="color: rgb(102, 217, 239);">if</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>error<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token function">reject<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>error<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>data<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

const gen <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  const f1 <span class="token operator" style="color: rgb(249, 38, 114);">=</span> yield <span class="token function">readFile<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'/etc/fstab'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  const f2 <span class="token operator" style="color: rgb(249, 38, 114);">=</span> yield <span class="token function">readFile<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'/etc/shells'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>f1<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">toString<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>f2<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">toString<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">写成<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数，就是下面这样。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const asyncReadFile <span class="token operator" style="color: rgb(249, 38, 114);">=</span> async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  const f1 <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">readFile<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'/etc/fstab'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  const f2 <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">readFile<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'/etc/shells'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>f1<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">toString<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>f2<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">toString<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">一比较就会发现，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数就是将 Generator 函数的星号（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">*</code>）替换成<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>，将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>替换成<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>，仅此而已。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数对 Generator 函数的改进，体现在以下四点。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（1）内置执行器。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Generator 函数的执行必须靠执行器，所以才有了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">co</code>模块，而<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数自带执行器。也就是说，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数的执行，与普通函数一模一样，只要一行。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token function">asyncReadFile<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面的代码调用了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">asyncReadFile</code>函数，然后它就会自动执行，输出最后结果。这完全不像 Generator 函数，需要调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，或者用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">co</code>模块，才能真正执行，得到最后结果。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（2）更好的语义。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>，比起星号和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>，语义更清楚了。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>表示函数里有异步操作，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>表示紧跟在后面的表达式需要等待结果。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（3）更广的适用性。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">co</code>模块约定，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令后面只能是 Thunk 函数或 Promise 对象，而<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令后面，可以是 Promise 对象和原始类型的值（数值、字符串和布尔值，但这时等同于同步操作）。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">（4）返回值是 Promise。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数的返回值是 Promise 对象，这比 Generator 函数的返回值是 Iterator 对象方便多了。你可以用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法指定下一步的操作。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">进一步说，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数完全可以看作多个异步操作，包装成的一个 Promise 对象，而<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令就是内部<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>命令的语法糖。</p><h2 id="基本用法" class="基本用法" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">基本用法</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数返回一个 Promise 对象，可以使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法添加回调函数。当函数执行的时候，一旦遇到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>就会先返回，等到异步操作完成，再接着执行函数体内后面的语句。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是一个例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">getStockPriceByName<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>name<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  const symbol <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">getStockSymbol<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>name<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  const stockPrice <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">getStockPrice<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>symbol<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> stockPrice<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">getStockPriceByName<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'goog'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>result<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>result<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码是一个获取股票报价的函数，函数前面的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>关键字，表明该函数内部有异步操作。调用该函数时，会立即返回一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Promise</code>对象。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是另一个例子，指定多少毫秒后输出一个值。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">timeout<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>ms<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Promise</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token function">setTimeout<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> ms<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">asyncPrint<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> ms<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  await <span class="token function">timeout<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>ms<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">asyncPrint<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'hello world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token number" style="color: rgb(174, 129, 255);">50</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码指定 50 毫秒以后，输出<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">hello world</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">由于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数返回的是 Promise 对象，可以作为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令的参数。所以，上面的例子也可以写成下面的形式。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">timeout<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>ms<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  await <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Promise</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token function">setTimeout<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> ms<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">asyncPrint<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> ms<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  await <span class="token function">timeout<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>ms<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">asyncPrint<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'hello world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token number" style="color: rgb(174, 129, 255);">50</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">async 函数有多种使用形式。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">// 函数声明
</span>async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">foo<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 函数表达式
</span>const foo <span class="token operator" style="color: rgb(249, 38, 114);">=</span> async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 对象的方法
</span><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> obj <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span> async <span class="token function">foo<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
obj<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">foo<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// Class 的方法
</span>class <span class="token class-name">Storage</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token function">constructor<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>cachePromise <span class="token operator" style="color: rgb(249, 38, 114);">=</span> caches<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">open<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'avatars'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

  async <span class="token function">getAvatar<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>name<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    const cache <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token keyword" style="color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>cachePromise<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> cache<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">match<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>`<span class="token operator" style="color: rgb(249, 38, 114);">/</span>avatars<span class="token operator" style="color: rgb(249, 38, 114);">/</span>$<span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>name<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>jpg`<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

const storage <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Storage</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
storage<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">getAvatar<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'jake'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>…<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 箭头函数
</span>const foo <span class="token operator" style="color: rgb(249, 38, 114);">=</span> async <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><h2 id="语法" class="语法" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">语法</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数的语法规则总体上比较简单，难点是错误处理机制。</p><h3 id="返回-Promise-对象" class="返回-Promise-对象" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">返回 Promise 对象</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数返回一个 Promise 对象。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数内部<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句返回的值，会成为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法回调函数的参数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token string">'hello world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// "hello world"
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>内部<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>命令返回的值，会被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法回调函数接收到。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数内部抛出错误，会导致返回的 Promise 对象变为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>状态。抛出的错误对象会被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>方法回调函数接收到。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">throw</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Error</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token string">'出错了'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>
  v <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span>
  e <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// Error: 出错了
</span></code></pre><h3 id="Promise-对象的状态变化" class="Promise-对象的状态变化" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">Promise 对象的状态变化</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数返回的 Promise 对象，必须等到内部所有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令后面的 Promise 对象执行完，才会发生状态改变，除非遇到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>语句或者抛出错误。也就是说，只有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数内部的异步操作执行完，才会执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法指定的回调函数。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是一个例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">getTitle<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>url<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> response <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">fetch<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>url<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> html <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await response<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">text<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> html<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">match<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token regex" style="color: rgb(253, 151, 31);">/&lt;title&gt;([\s\S]+)&lt;\/title&gt;/i</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token number" style="color: rgb(174, 129, 255);">1</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token function">getTitle<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'https://tc39.github.io/ecma262/'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>log<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// "ECMAScript 2017 Language Specification"
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">getTitle</code>内部有三个操作：抓取网页、取出文本、匹配页面标题。只有这三个操作全部完成，才会执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法里面的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">console.log</code>。</p><h3 id="await-命令" class="await-命令" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">await 命令</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">正常情况下，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令后面是一个 Promise 对象。如果不是，会被转成一个立即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">resolve</code>的 Promise 对象。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> await <span class="token number" style="color: rgb(174, 129, 255);">123</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 123
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令的参数是数值<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">123</code>，它被转成 Promise 对象，并立即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">resolve</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令后面的 Promise 对象如果变为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>状态，则<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>的参数会被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>方法的回调函数接收到。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">reject<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'出错了'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 出错了
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">注意，上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>语句前面没有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>，但是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>方法的参数依然传入了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>方法的回调函数。这里如果在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>前面加上<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">return</code>，效果是一样的。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">只要一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>语句后面的 Promise 变为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>，那么整个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数都会中断执行。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">reject<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'出错了'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'hello world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 不会执行
</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，第二个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>语句是不会执行的，因为第一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>语句状态变成了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">有时，我们希望即使前一个异步操作失败，也不要中断后面的异步操作。这时可以将第一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>放在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>结构里面，这样不管这个异步操作是否成功，第二个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>都会执行。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">reject<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'出错了'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'hello world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// hello world
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">另一种方法是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>后面的 Promise 对象再跟一个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>方法，处理前面可能出现的错误。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">reject<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'出错了'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'hello world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 出错了
</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">// hello world
</span></code></pre><h3 id="错误处理" class="错误处理" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">错误处理</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>后面的异步操作出错，那么等同于<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数返回的 Promise 对象被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  await <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Promise</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> reject<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">throw</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Error</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token string">'出错了'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// Error：出错了
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">f</code>执行后，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>后面的 Promise 对象会抛出一个错误对象，导致<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>方法的回调函数被调用，它的参数就是抛出的错误对象。具体的执行机制，可以参考后文的“async 函数的实现原理”。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">防止出错的方法，也是将其放在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块之中。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    await <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Promise</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> reject<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      <span class="token keyword" style="color: rgb(102, 217, 239);">throw</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Error</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token string">'出错了'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token function">await<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'hello world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果有多个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令，可以统一放在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>结构中。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">main<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    const val1 <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">firstStep<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    const val2 <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">secondStep<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>val1<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    const val3 <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">thirdStep<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>val1<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> val2<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'Final: '</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> val3<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token class-name">err</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">error<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>err<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面的例子使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>结构，实现多次重复尝试。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const superagent <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">require<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'superagent'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
const NUM_RETRIES <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token number" style="color: rgb(174, 129, 255);">3</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">test<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> i<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>i <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token number" style="color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span> i <span class="token operator" style="color: rgb(249, 38, 114);">&lt;</span> NUM_RETRIES<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span> <span class="token operator" style="color: rgb(249, 38, 114);">++</span>i<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      await superagent<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">get</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token string">'http://google.com/this-throws-an-error'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token keyword" style="color: rgb(102, 217, 239);">break</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>err<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>i<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 3
</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">test<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，如果<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>操作成功，就会使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">break</code>语句退出循环；如果失败，会被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>语句捕捉，然后进入下一轮循环。</p><h3 id="使用注意点" class="使用注意点" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">使用注意点</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第一点，前面已经说过，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令后面的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Promise</code>对象，运行结果可能是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">rejected</code>，所以最好把<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令放在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>代码块中。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">myFunction<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    await <span class="token function">somethingThatReturnsAPromise<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token class-name">err</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>err<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 另一种写法
</span>
async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">myFunction<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  await <span class="token function">somethingThatReturnsAPromise<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>err<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>err<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第二点，多个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令后面的异步操作，如果不存在继发关系，最好让它们同时触发。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> foo <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">getFoo<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token keyword" style="color: rgb(102, 217, 239);">let</span> bar <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">getBar<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">getFoo</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">getBar</code>是两个独立的异步操作（即互不依赖），被写成继发关系。这样比较耗时，因为只有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">getFoo</code>完成以后，才会执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">getBar</code>，完全可以让它们同时触发。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">// 写法一
</span><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span>foo<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> bar<span class="token punctuation" style="color: rgb(248, 248, 242);">]</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">all<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token function">getFoo<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token function">getBar<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 写法二
</span><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> fooPromise <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">getFoo<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token keyword" style="color: rgb(102, 217, 239);">let</span> barPromise <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">getBar<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token keyword" style="color: rgb(102, 217, 239);">let</span> foo <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await fooPromise<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token keyword" style="color: rgb(102, 217, 239);">let</span> bar <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await barPromise<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面两种写法，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">getFoo</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">getBar</code>都是同时触发，这样就会缩短程序的执行时间。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">第三点，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令只能用在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数之中，如果用在普通函数，就会报错。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">dbFuc<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>db<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> docs <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 报错
</span>  docs<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">forEach<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    await db<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">post<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码会报错，因为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>用在普通函数之中了。但是，如果将<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">forEach</code>方法的参数改成<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数，也有问题。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">dbFuc<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>db<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> //这里不需要 async
</span>  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> docs <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 可能得到错误结果
</span>  docs<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">forEach<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    await db<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">post<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码可能不会正常工作，原因是这时三个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">db.post</code>操作将是并发执行，也就是同时执行，而不是继发执行。正确的写法是采用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for</code>循环。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">dbFuc<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>db<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> docs <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> doc of docs<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    await db<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">post<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果确实希望多个请求并发执行，可以使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Promise.all</code>方法。当三个请求都会<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">resolved</code>时，下面两种写法效果相同。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">dbFuc<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>db<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> docs <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> promises <span class="token operator" style="color: rgb(249, 38, 114);">=</span> docs<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">map<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> db<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">post<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> results <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">all<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>promises<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>results<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 或者使用下面的写法
</span>
async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">dbFuc<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>db<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> docs <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> promises <span class="token operator" style="color: rgb(249, 38, 114);">=</span> docs<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">map<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> db<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">post<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>doc<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> results <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> promise of promises<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    results<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">push<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>await promise<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>results<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">目前，<a href="https://www.npmjs.com/package/@std/esm" style="background-position: initial; color: rgb(70, 130, 190);"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">@std/esm</code></a>模块加载器支持顶层<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>，即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令可以不放在 async 函数里面，直接使用。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">// async 函数的写法
</span>const start <span class="token operator" style="color: rgb(249, 38, 114);">=</span> async <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  const res <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">fetch<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'google.com'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> res<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">text<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

<span class="token function">start<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>log<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 顶层 await 的写法
</span>const res <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">fetch<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'google.com'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>await res<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">text<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，第二种写法的脚本必须使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">@std/esm</code>加载器，才会生效。</p><h2 id="async-函数的实现原理" class="async-函数的实现原理" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">async 函数的实现原理</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">async 函数的实现原理，就是将 Generator 函数和自动执行器，包装在一个函数里。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">fn<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>args<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // ...
</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 等同于
</span>
<span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">fn<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>args<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token function">spawn<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
   <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // ...
</span>  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">所有的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数都可以写成上面的第二种形式，其中的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">spawn</code>函数就是自动执行器。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面给出<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">spawn</code>函数的实现，基本就是前文自动执行器的翻版。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">spawn<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>genF<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Promise</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> reject<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    const gen <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">genF<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">step<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>nextF<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> next<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
        next <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">nextF<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
        <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token function">reject<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
      <span class="token keyword" style="color: rgb(102, 217, 239);">if</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>next<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>done<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
        <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>next<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
      Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>next<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
        <span class="token function">step<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span> <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> gen<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
        <span class="token function">step<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span> <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> gen<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">throw</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
    <span class="token function">step<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span> <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> gen<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>undefined<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><h2 id="与其他异步处理方法的比较" class="与其他异步处理方法的比较" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">与其他异步处理方法的比较</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">我们通过一个例子，来看 async 函数与 Promise、Generator 函数的比较。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">假定某个 DOM 元素上面，部署了一系列的动画，前一个动画结束，才能开始后一个。如果当中有一个动画出错，就不再往下执行，返回上一个成功执行的动画的返回值。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">首先是 Promise 的写法。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">chainAnimationsPromise<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>elem<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> animations<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>

 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 变量ret用来保存上一个动画的返回值
</span>  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> ret <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token keyword" style="color: rgb(102, 217, 239);">null</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 新建一个空的Promise
</span>  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> p <span class="token operator" style="color: rgb(249, 38, 114);">=</span> Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 使用then方法，添加所有动画
</span>  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> anim of animations<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    p <span class="token operator" style="color: rgb(249, 38, 114);">=</span> p<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>val<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      ret <span class="token operator" style="color: rgb(249, 38, 114);">=</span> val<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token function">anim<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>elem<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 返回一个部署了错误捕捉机制的Promise
</span>  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> p<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">/* 忽略错误，继续执行 */</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> ret<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">虽然 Promise 的写法比回调函数的写法大大改进，但是一眼看上去，代码完全都是 Promise 的 API（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>、<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>等等），操作本身的语义反而不容易看出来。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">接着是 Generator 函数的写法。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">chainAnimationsGenerator<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>elem<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> animations<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>

  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token function">spawn<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> ret <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token keyword" style="color: rgb(102, 217, 239);">null</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      <span class="token keyword" style="color: rgb(102, 217, 239);">for</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> anim of animations<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
        ret <span class="token operator" style="color: rgb(249, 38, 114);">=</span> yield <span class="token function">anim<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>elem<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
      <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">/* 忽略错误，继续执行 */</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> ret<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码使用 Generator 函数遍历了每个动画，语义比 Promise 写法更清晰，用户定义的操作全部都出现在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">spawn</code>函数的内部。这个写法的问题在于，必须有一个任务运行器，自动执行 Generator 函数，上面代码的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">spawn</code>函数就是自动执行器，它返回一个 Promise 对象，而且必须保证<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>语句后面的表达式，必须返回一个 Promise。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">最后是 async 函数的写法。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">chainAnimationsAsync<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>elem<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> animations<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> ret <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token keyword" style="color: rgb(102, 217, 239);">null</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">for</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> anim of animations<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      ret <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">anim<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>elem<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">/* 忽略错误，继续执行 */</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> ret<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">可以看到 Async 函数的实现最简洁，最符合语义，几乎没有语义不相关的代码。它将 Generator 写法中的自动执行器，改在语言层面提供，不暴露给用户，因此代码量最少。如果使用 Generator 写法，自动执行器需要用户自己提供。</p><h2 id="实例：按顺序完成异步操作" class="实例：按顺序完成异步操作" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">实例：按顺序完成异步操作</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">实际开发中，经常遇到一组异步操作，需要按照顺序完成。比如，依次远程读取一组 URL，然后按照读取的顺序输出结果。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">Promise 的写法如下。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">logInOrder<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>urls<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 远程读取所有URL
</span>  const textPromises <span class="token operator" style="color: rgb(249, 38, 114);">=</span> urls<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">map<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>url <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token function">fetch<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>url<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>response <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> response<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">text<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 按次序输出
</span>  textPromises<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">reduce<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>chain<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> textPromise<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> chain<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> textPromise<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
      <span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>text <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>text<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">fetch</code>方法，同时远程读取一组 URL。每个<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">fetch</code>操作都返回一个 Promise 对象，放入<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">textPromises</code>数组。然后，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reduce</code>方法依次处理每个 Promise 对象，然后使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>，将所有 Promise 对象连起来，因此就可以依次输出结果。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这种写法不太直观，可读性比较差。下面是 async 函数实现。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">logInOrder<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>urls<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const url of urls<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    const response <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">fetch<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>url<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>await response<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">text<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码确实大大简化，问题是所有远程操作都是继发。只有前一个 URL 返回结果，才会去读取下一个 URL，这样做效率很差，非常浪费时间。我们需要的是并发发出远程请求。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">logInOrder<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>urls<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 并发读取远程URL
</span>  const textPromises <span class="token operator" style="color: rgb(249, 38, 114);">=</span> urls<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">map<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>async url <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    const response <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">fetch<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>url<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> response<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">text<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 按次序输出
</span>  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const textPromise of textPromises<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>await textPromise<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，虽然<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">map</code>方法的参数是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数，但它是并发执行的，因为只有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数内部是继发执行，外部不受影响。后面的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for..of</code>循环内部使用了<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>，因此实现了按顺序输出。</p><h2 id="异步遍历器" class="异步遍历器" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; font-size: 18px; border-top: 2px solid rgb(102, 102, 102); counter-increment: section 1; color: rgb(51, 51, 51); font-family: Verdana, Arial;">异步遍历器</h2><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">《遍历器》一章说过，Iterator 接口是一种数据遍历的协议，只要调用遍历器对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，就会得到一个对象，表示当前遍历指针所在的那个位置的信息。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法返回的对象的结构是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">{value, done}</code>，其中<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>表示当前的数据的值，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>是一个布尔值，表示遍历是否结束。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">这里隐含着一个规定，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法必须是同步的，只要调用就必须立刻返回值。也就是说，一旦执行<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，就必须同步地得到<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>这两个属性。如果遍历指针正好指向同步操作，当然没有问题，但对于异步操作，就不太合适了。目前的解决方法是，Generator 函数里面的异步操作，返回一个 Thunk 函数或者 Promise 对象，即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性是一个 Thunk 函数或者 Promise 对象，等待以后返回真正的值，而<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性则还是同步产生的。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">目前，有一个<a href="https://github.com/tc39/proposal-async-iteration" style="background-position: initial; color: rgb(70, 130, 190);">提案</a>，为异步操作提供原生的遍历器接口，即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>这两个属性都是异步产生，这称为”异步遍历器“（Async Iterator）。</p><h3 id="异步遍历的接口" class="异步遍历的接口" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">异步遍历的接口</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">异步遍历器的最大的语法特点，就是调用遍历器的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，返回的是一个 Promise 对象。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">asyncIterator
  <span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span> value<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> done <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">/* ... */</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">asyncIterator</code>是一个异步遍历器，调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法以后，返回一个 Promise 对象。因此，可以使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法指定，这个 Promise 对象的状态变为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">resolve</code>以后的回调函数。回调函数的参数，则是一个具有<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>两个属性的对象，这个跟同步遍历器是一样的。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">我们知道，一个对象的同步遍历器的接口，部署在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.iterator</code>属性上面。同样地，对象的异步遍历器接口，部署在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.asyncIterator</code>属性上面。不管是什么样的对象，只要它的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Symbol.asyncIterator</code>属性有值，就表示应该对它进行异步遍历。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是一个异步遍历器的例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const asyncIterable <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">createAsyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token string">'a'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token string">'b'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
const asyncIterator <span class="token operator" style="color: rgb(249, 38, 114);">=</span> asyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">[</span>Symbol<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

asyncIterator
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>iterResult1 <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>iterResult1<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // { value: 'a', done: false }
</span>  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>iterResult2 <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>iterResult2<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // { value: 'b', done: false }
</span>  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>iterResult3 <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>iterResult3<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // { value: undefined, done: true }
</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，异步遍历器其实返回了两次值。第一次调用的时候，返回一个 Promise 对象；等到 Promise 对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">resolve</code>了，再返回一个表示当前数据成员信息的对象。这就是说，异步遍历器与同步遍历器最终行为是一致的，只是会先返回 Promise 对象，作为中介。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">由于异步遍历器的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，返回的是一个 Promise 对象。因此，可以把它放在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令后面。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  const asyncIterable <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">createAsyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token string">'a'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token string">'b'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  const asyncIterator <span class="token operator" style="color: rgb(249, 38, 114);">=</span> asyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">[</span>Symbol<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>await asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // { value: 'a', done: false }
</span>  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>await asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // { value: 'b', done: false }
</span>  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>await asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // { value: undefined, done: true }
</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>处理以后，就不必使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法了。整个流程已经很接近同步处理了。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">注意，异步遍历器的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法是可以连续调用的，不必等到上一步产生的 Promise 对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">resolve</code>以后再调用。这种情况下，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法会累积起来，自动按照每一步的顺序运行下去。下面是一个例子，把所有的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法放在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Promise.all</code>方法里面。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const asyncGenObj <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">createAsyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token string">'a'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token string">'b'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
const <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">:</span> v1<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">:</span> v2<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await Promise<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">all<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">[</span>
  asyncGenObj<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> asyncGenObj<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>v1<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> v2<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // a b
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">另一种用法是一次性调用所有的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，然后<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>最后一步操作。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const writer <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">openFile<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'someFile.txt'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
writer<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'hello'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
writer<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
await writer<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">return</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><h3 id="for-await---of" class="for-await---of" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">for await...of</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">前面介绍过，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环用于遍历同步的 Iterator 接口。新引入的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for await...of</code>循环，则是用于遍历异步的 Iterator 接口。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> await <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const x of <span class="token function">createAsyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token string">'a'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token string">'b'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>x<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// a
</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">// b
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">createAsyncIterable()</code>返回一个异步遍历器，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>循环自动调用这个遍历器的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，会得到一个 Promise 对象。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>用来处理这个 Promise 对象，一旦<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">resolve</code>，就把得到的值（<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">x</code>）传入<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for...of</code>的循环体。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for await...of</code>循环的一个用途，是部署了 asyncIterable 操作的异步接口，可以直接放入这个循环。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">let</span> body <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token string">''</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> <span class="token function">await<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>const data of req<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> body <span class="token operator" style="color: rgb(249, 38, 114);">+</span><span class="token operator" style="color: rgb(249, 38, 114);">=</span> data<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  const parsed <span class="token operator" style="color: rgb(249, 38, 114);">=</span> JSON<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">parse<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>body<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'got'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> parsed<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">req</code>是一个 asyncIterable 对象，用来异步读取数据。可以看到，使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for await...of</code>循环以后，代码会非常简洁。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法返回的 Promise 对象被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for await...of</code>就会报错，要用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">try...catch</code>捕捉。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> await <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const x of <span class="token function">createRejectingIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>x<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">catch</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token class-name">e</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">error<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>e<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">注意，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for await...of</code>循环也可以用于同步遍历器。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> await <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const x of <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token string">'a'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> <span class="token string">'b'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>x<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// a
</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">// b
</span></code></pre><h3 id="异步-Generator-函数" class="异步-Generator-函数" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">异步 Generator 函数</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">就像 Generator 函数返回一个同步遍历器对象一样，异步 Generator 函数的作用，是返回一个异步遍历器对象。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">在语法上，异步 Generator 函数就是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">async</code>函数与 Generator 函数的结合。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">gen<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  yield <span class="token string">'hello'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
const genObj <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">gen<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
genObj<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>x <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>x<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// { value: 'hello', done: false }
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen</code>是一个异步 Generator 函数，执行后返回一个异步 Iterator 对象。对该对象调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，返回一个 Promise 对象。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">异步遍历器的设计目的之一，就是 Generator 函数处理同步操作和异步操作时，能够使用同一套接口。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">// 同步 Generator 函数
</span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">map<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>iterable<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> func<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  const iter <span class="token operator" style="color: rgb(249, 38, 114);">=</span> iterable<span class="token punctuation" style="color: rgb(248, 248, 242);">[</span>Symbol<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>iterator<span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">while</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token boolean" style="color: rgb(174, 129, 255);">true</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    const <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> done<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span> iter<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">if</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>done<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token keyword" style="color: rgb(102, 217, 239);">break</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    yield <span class="token function">func<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// 异步 Generator 函数
</span>async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">map<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>iterable<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> func<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  const iter <span class="token operator" style="color: rgb(249, 38, 114);">=</span> iterable<span class="token punctuation" style="color: rgb(248, 248, 242);">[</span>Symbol<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">while</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token boolean" style="color: rgb(174, 129, 255);">true</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    const <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> done<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await iter<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">if</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>done<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token keyword" style="color: rgb(102, 217, 239);">break</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    yield <span class="token function">func<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，可以看到有了异步遍历器以后，同步 Generator 函数和异步 Generator 函数的写法基本上是一致的。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是另一个异步 Generator 函数的例子。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">readLines<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>path<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">let</span> file <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">fileOpen<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>path<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>

  <span class="token keyword" style="color: rgb(102, 217, 239);">try</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">while</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token operator" style="color: rgb(249, 38, 114);">!</span>file<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>EOF<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
      yield await file<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">readLine<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token keyword" style="color: rgb(102, 217, 239);">finally</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    await file<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">close<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，异步操作前面使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>关键字标明，即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>后面的操作，应该返回 Promise 对象。凡是使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>关键字的地方，就是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的停下来的地方，它后面的表达式的值（即<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await file.readLine()</code>的值），会作为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next()</code>返回对象的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>属性，这一点是与同步 Generator 函数一致的。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">异步 Generator 函数内部，能够同时使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>和<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令。可以这样理解，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令用于将外部操作产生的值输入函数内部，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令用于将函数内部的值输出。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码定义的异步 Generator 函数的用法如下。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> await <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const line of <span class="token function">readLines<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>filePath<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>line<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">异步 Generator 函数可以与<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for await...of</code>循环结合起来使用。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">prefixLines<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>asyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> await <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const line of asyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    yield <span class="token string">'&gt; '</span> <span class="token operator" style="color: rgb(249, 38, 114);">+</span> line<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">异步 Generator 函数的返回值是一个异步 Iterator，即每次调用它的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法，会返回一个 Promise 对象，也就是说，跟在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令后面的，应该是一个 Promise 对象。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">asyncGenerator<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'Start'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  const result <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await <span class="token function">doSomethingAsync<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // (A)
</span>  yield <span class="token string">'Result: '</span><span class="token operator" style="color: rgb(249, 38, 114);">+</span> result<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // (B)
</span>  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'Done'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

const ag <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">asyncGenerator<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
ag<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> done<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // ...
</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">ag</code>是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">asyncGenerator</code>函数返回的异步 Iterator 对象。调用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">ag.next()</code>以后，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">asyncGenerator</code>函数内部的执行顺序如下。</p><ol style="padding-top: 0.5rem; padding-bottom: 0.5rem; color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><li style="text-indent: -5px; font-size: 0.8rem;">打印出<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">Start</code>。</li><li style="text-indent: -5px; font-size: 0.8rem;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令返回一个 Promise 对象，但是程序不会停在这里，继续往下执行。</li><li style="text-indent: -5px; font-size: 0.8rem;">程序在<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">B</code>处暂停执行，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield</code>命令立刻返回一个 Promise 对象，该对象就是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">ag.next()</code>的返回值。</li><li style="text-indent: -5px; font-size: 0.8rem;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">A</code>处<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令后面的那个 Promise 对象 resolved，产生的值放入<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">result</code>变量。</li><li style="text-indent: -5px; font-size: 0.8rem;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">B</code>处的 Promise 对象 resolved，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">then</code>方法指定的回调函数开始执行，该函数的参数是一个对象，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">value</code>的值是表达式<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">'Result： ' + result</code>的值，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性的值是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">false</code>。</li></ol><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">A 和 B 两行的作用类似于下面的代码。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Promise</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> reject<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token function">doSomethingAsync<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>result <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
     <span class="token function">resolve<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
       value<span class="token punctuation" style="color: rgb(248, 248, 242);">:</span> <span class="token string">'Result: '</span><span class="token operator" style="color: rgb(249, 38, 114);">+</span>result<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span>
       done<span class="token punctuation" style="color: rgb(248, 248, 242);">:</span> <span class="token boolean" style="color: rgb(174, 129, 255);">false</span><span class="token punctuation" style="color: rgb(248, 248, 242);">,</span>
     <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">如果异步 Generator 函数抛出错误，会被 Promise 对象<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">reject</code>，然后抛出的错误被<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">catch</code>方法捕获。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">asyncGenerator<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">throw</span> <span class="token keyword" style="color: rgb(102, 217, 239);">new</span> <span class="token class-name">Error</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token string">'Problem!'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">asyncGenerator<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">catch</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>err <span class="token operator" style="color: rgb(249, 38, 114);">=</span><span class="token operator" style="color: rgb(249, 38, 114);">&gt;</span> console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>err<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // Error: Problem!
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">注意，普通的 async 函数返回的是一个 Promise 对象，而异步 Generator 函数返回的是一个异步 Iterator 对象。可以这样理解，async 函数和异步 Generator 函数，是封装异步操作的两种方法，都用来达到同一种目的。区别在于，前者自带执行器，后者通过<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for await...of</code>执行，或者自己编写执行器。下面就是一个异步 Generator 函数的执行器。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">takeAsync<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>asyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> count <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token number" style="color: rgb(174, 129, 255);">Infinity</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  const result <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">[</span><span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  const iterator <span class="token operator" style="color: rgb(249, 38, 114);">=</span> asyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">[</span>Symbol<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>asyncIterator<span class="token punctuation" style="color: rgb(248, 248, 242);">]</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">while</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>result<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span>length <span class="token operator" style="color: rgb(249, 38, 114);">&lt;</span> count<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    const <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">,</span> done<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span> <span class="token operator" style="color: rgb(249, 38, 114);">=</span> await iterator<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    <span class="token keyword" style="color: rgb(102, 217, 239);">if</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>done<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token keyword" style="color: rgb(102, 217, 239);">break</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    result<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">push<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>value<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> result<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，异步 Generator 函数产生的异步遍历器，会通过<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">while</code>循环自动执行，每当<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await iterator.next()</code>完成，就会进入下一轮循环。一旦<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">done</code>属性变为<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">true</code>，就会跳出循环，异步遍历器执行结束。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">下面是这个自动执行器的一个使用实例。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">gen<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    yield <span class="token string">'a'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    yield <span class="token string">'b'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
    yield <span class="token string">'c'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> await <span class="token function">takeAsync<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token function">gen<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

<span class="token function">f<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">then<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>result<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>result<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // ['a', 'b', 'c']
</span><span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">异步 Generator 函数出现以后，JavaScript 就有了四种函数形式：普通函数、async 函数、Generator 函数和异步 Generator 函数。请注意区分每种函数的不同之处。基本上，如果是一系列按照顺序执行的异步操作（比如读取文件，然后写入新内容，再存入硬盘），可以使用 async 函数；如果是一系列产生相同数据结构的异步操作（比如一行一行读取文件），可以使用异步 Generator 函数。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">异步 Generator 函数也可以通过<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的参数，接收外部传入的数据。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">const writer <span class="token operator" style="color: rgb(249, 38, 114);">=</span> <span class="token function">openFile<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'someFile.txt'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
writer<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'hello'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 立即执行
</span>writer<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">next<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token string">'world'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 立即执行
</span>await writer<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token keyword" style="color: rgb(102, 217, 239);">return</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // 等待写入结束
</span></code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">openFile</code>是一个异步 Generator 函数。<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法的参数，向该函数内部的操作传入数据。每次<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">next</code>方法都是同步执行的，最后的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>命令用于等待整个写入操作结束。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">最后，同步的数据结构，也可以使用异步 Generator 函数。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">createAsyncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>syncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const elem of syncIterable<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    yield elem<span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，由于没有异步操作，所以也就没有使用<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">await</code>关键字。</p><h3 id="yield--语句" class="yield--语句" style="margin-top: 50px; margin-bottom: 0px; padding-top: 20px; padding-bottom: 0px; border-top: 1px dotted rgb(119, 119, 119); color: rgb(51, 51, 51); font-family: Verdana, Arial;">yield* 语句</h3><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;"><code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>语句也可以跟一个异步遍历器。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;">async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">gen1<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  yield <span class="token string">'a'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  yield <span class="token string">'b'</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">return</span> <span class="token number" style="color: rgb(174, 129, 255);">2</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>

async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span><span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">gen2<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
 <span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);"> // result 最终会等于 2
</span>  const result <span class="token operator" style="color: rgb(249, 38, 114);">=</span> yield<span class="token operator" style="color: rgb(249, 38, 114);">*</span> <span class="token function">gen1<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
</code></pre><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">上面代码中，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">gen2</code>函数里面的<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">result</code>变量，最后的值是<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">2</code>。</p><p style="color: rgb(51, 51, 51); font-family: Verdana, Arial; font-size: 14.336px;">与同步 Generator 函数一样，<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">for await...of</code>循环会展开<code style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(199, 37, 78); background: rgb(249, 242, 244); border-radius: 2px; padding-left: 3px; padding-right: 3px;">yield*</code>。</p><pre class=" language-javascript" style="font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; font-size: 14.336px; color: rgb(255, 255, 255); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-break: normal; hyphens: none; padding-right: 1em; padding-left: 0.7rem; margin: 0.5em auto; border-radius: 5px; background-color: rgb(17, 17, 17); line-height: 1.2;"><code class=" language-javascript" style="font-family: Consolas, &quot;Courier New&quot;, Courier, FreeMono, monospace; font-size: 0.7rem; color: rgb(166, 226, 46); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; direction: ltr; word-spacing: normal; word-break: normal; tab-size: 4; hyphens: none; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; border-radius: 2px;"><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>async <span class="token keyword" style="color: rgb(102, 217, 239);">function</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
  <span class="token keyword" style="color: rgb(102, 217, 239);">for</span> await <span class="token punctuation" style="color: rgb(248, 248, 242);">(</span>const x of <span class="token function">gen2<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span> <span class="token punctuation" style="color: rgb(248, 248, 242);">{</span>
    console<span class="token punctuation" style="color: rgb(248, 248, 242);">.</span><span class="token function">log<span class="token punctuation" style="color: rgb(248, 248, 242);">(</span></span>x<span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span>
  <span class="token punctuation" style="color: rgb(248, 248, 242);">}</span>
<span class="token punctuation" style="color: rgb(248, 248, 242);">}</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">(</span><span class="token punctuation" style="color: rgb(248, 248, 242);">)</span><span class="token punctuation" style="color: rgb(248, 248, 242);">;</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">
// a
</span><span class="token comment" spellcheck="true" style="color: rgb(117, 113, 94);">// b</span></code></pre></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div>
    </div>      
  </article>
</div>      
{% endblock %}